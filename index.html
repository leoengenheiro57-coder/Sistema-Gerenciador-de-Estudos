<!DOCTYPE html>
<html lang="pt-BR" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciador de Estudos para Concursos (IndexedDB - V11)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/localforage@1.10.0/dist/localforage.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
        }
        .modal-backdrop {
            display: none; position: fixed; top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.5); z-index: 40;
        }
        .modal {
            display: none; position: fixed; top: 50%; left: 50%;
            transform: translate(-50%, -50%); z-index: 50;
            max-height: 90vh; overflow-y: auto;
        }
        #notes-modal {
            /* Tamanho padr√£o do modal de notas */
            max-width: 900px;
            max-height: 95vh;
        }
        /* -- ALTERA√á√ÉO: MAXIMIZAR MODAL -- */
        .modal.maximized {
            width: 100vw !important;
            height: 100vh !important;
            max-width: 100vw !important;
            max-height: 100vh !important;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border-radius: 0 !important;
        }
        .modal.maximized .modal-content-area {
            height: 100%;
        }
        .modal.maximized #notes-editor {
            height: calc(100vh - 170px) !important; /* Altura total - cabe√ßalho fixo */
            min-height: 100px; /* Garante que n√£o fique muito pequeno */
            padding-top: 5px;
        }
        /* ---------------------------------- */

        .progress-bar-bg { background-color: #e0e0e0; }
        .progress-bar-fill { transition: width 0.3s ease-in-out; }
        .tooltip { position: relative; display: inline-block; }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 300px;
            background-color: #555;
            color: #fff;
            text-align: left;
            border-radius: 6px;
            padding: 8px 12px;
            position: absolute;
            z-index: 10;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            white-space: normal;
            word-break: break-word;
        }
        .tooltip:hover .tooltiptext { visibility: visible; opacity: 1; }
        .accordion-content {
            transition: max-height 0.3s ease-out;
            max-height: 0;
            overflow: hidden;
        }
        .accordion-content.open {
            max-height: 5000px;
        }
        .chevron {
            transition: transform 0.3s ease-in-out;
        }
        .day-filter-btn.active {
            background-color: #4f46e5;
            color: white;
        }
        .day-filter-btn.highlight {
            background-color: #FBBF24;
            color: #78350F;
        }
        .dark .day-filter-btn.highlight {
            background-color: #D97706;
            color: #FEF3C7;
        }
        .hidden { display: none; }
        
        .note-format-btn {
            width: 32px; height: 32px; display: flex;
            align-items: center; justify-content: center;
            border: 1px solid transparent; border-radius: 4px;
            background-color: white;
            cursor: pointer;
        }
        .dark .note-format-btn {
            background-color: #374151;
        }
        .note-format-btn:hover {
            background-color: #eef2ff;
            border-color: #c7d2fe;
        }
        .dark .note-format-btn:hover {
            background-color: #4b5563;
        }
        #notes-modal-header {
            position: sticky;
            top: 0;
            z-index: 40; /* Aumentado o z-index para garantir a fixa√ß√£o */
            padding-bottom: 0.5rem; 
            background-color: inherit; 
        }
        .dark #notes-modal-header {
            background-color: #1e293b; 
        }
        
        #notes-toolbar {
            position: sticky;
            top: 60px; /* Ajustado para estar abaixo do cabe√ßalho */
            z-index: 30; 
            margin-top: 0;
            border-top: none;
            border-radius: 0 0 0 0;
        }
        #notes-modal-title {
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #e2e8f0;
            margin-bottom: 0.5rem;
            background-color: inherit; 
            /* -- ALTERA√á√ÉO: MAXIMIZAR MODAL -- */
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .dark #notes-modal-title {
            border-bottom-color: #334155;
        }

        #notes-editor {
             min-height: 20rem;
             padding-top: 100px;
        }
        /* Ajuste de altura no editor para o modo normal, considerando o header fixo */
        #notes-modal:not(.maximized) #notes-editor {
            min-height: 20rem;
            max-height: calc(95vh - 180px);
            padding-top: 5px;
        }
        /* Remove o padding-top excessivo do JS que estava sobrepondo o sticky header */
        #notes-modal:not(.maximized) #notes-editor {
            padding-top: 5px;
        }


        .discipline-card.completed-today {
            background-color: #ECFDF5; 
            border: 2px solid #10B981;
        }
        .dark .discipline-card.completed-today {
             background-color: #064E3B;
             border: 2px solid #059669;
        }

        #notes-editor:focus {
            border-color: #6366f1;
            box-shadow: 0 0 0 1px #6366f1;
        }
        #notes-editor img {
            max-width: 100%;
            border-radius: 8px;
            margin-top: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            resize: both;
            overflow: hidden;
        }
        #notes-editor img.selected {
            outline: 3px solid #4f46e5;
        }
        .search-highlight {
            background-color: #fefcbf;
        }

    </style>
</head>
<body class="antialiased text-slate-800 dark:bg-slate-900 dark:text-slate-300">

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">
        <header class="mb-8 flex justify-between items-center flex-wrap gap-4">
              <div>
                  <h1 class="text-3xl md:text-4xl font-bold text-slate-900 dark:text-slate-100">Painel de Estudos</h1>
                  <p class="text-slate-600 dark:text-slate-400 mt-1">Seu plano de estudos di√°rio.</p>
              </div>
              <div class="flex items-center gap-2 flex-wrap">
                   <button id="dark-mode-toggle" class="p-2 rounded-lg text-slate-500 hover:bg-slate-200 dark:text-slate-400 dark:hover:bg-slate-700 transition-colors">
                        <svg id="theme-toggle-dark-icon" class="w-5 h-5 hidden" fill="currentColor" viewBox="0 0 20 20"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
                        <svg id="theme-toggle-light-icon" class="w-5 h-5 hidden" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.707.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm-.707 7.072l.707-.707a1 1 0 10-1.414-1.414l-.707.707a1 1 0 001.414 1.414zM3 11a1 1 0 100-2H2a1 1 0 100 2h1z" fill-rule="evenodd" clip-rule="evenodd"></path></svg>
                   </button>
                    <button id="clear-all-btn" class="bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700 transition-colors text-sm" title="Limpar todo o planejamento">
                        Limpar Tudo
                    </button>
                    <button id="critical-subjects-btn" class="bg-orange-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-orange-700 transition-colors text-sm" title="Analisar Mat√©rias Cr√≠ticas">
                    An√°lise Cr√≠tica
                    </button>
                    <button id="planning-btn" class="bg-violet-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-violet-700 transition-colors text-sm">
                    Planejamento
                    </button>
                    <button id="cycle-calculator-btn" class="bg-teal-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-teal-700 transition-colors text-sm">
                    C√°lculo de Ciclo
                    </button>
                    <button id="stats-btn" class="bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-purple-700 transition-colors text-sm">
                    Estat√≠sticas
                    </button>
                <button id="toggle-form-btn" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors text-sm">
                    + Adicionar
                </button>
              </div>
        </header>

        <div class="mb-8 relative">
            <input type="search" id="global-search" placeholder="Buscar mat√©ria, tema ou assunto..." class="w-full p-4 pl-10 border border-slate-300 rounded-lg bg-white focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:bg-slate-800 dark:border-slate-700 dark:text-white dark:placeholder-slate-400">
            <svg class="w-5 h-5 absolute top-1/2 left-3 transform -translate-y-1/2 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
        </div>


        <div id="sticky-header" class="sticky top-0 z-30 bg-[#f0f2f5] dark:bg-slate-900 pt-4 -mt-4">
            <div id="toggleable-content" class="hidden">
                <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-md mb-8">
                    <h2 class="text-xl font-semibold mb-4 border-b pb-3 dark:text-slate-200 dark:border-slate-700">Adicionar Novo Assunto</h2>
                    <form id="add-topic-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="md:col-span-2">
                            <label for="discipline-select" class="block text-sm font-medium text-slate-700 dark:text-slate-400 mb-1">Mat√©ria (Disciplina)</label>
                            <div class="flex gap-2">
                                <select id="discipline-select" class="w-full p-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:bg-slate-700 dark:border-slate-600 dark:text-white" required></select>
                                <button type="button" id="add-new-discipline-btn" class="bg-indigo-600 text-white font-bold p-3 rounded-lg hover:bg-indigo-700 transition-colors tooltip">
                                    + <span class="tooltiptext">Nova Mat√©ria</span>
                                </button>
                            </div>
                        </div>
                        <div>
                            <label for="theme-name" class="block text-sm font-medium text-slate-700 dark:text-slate-400 mb-1">Tema</label>
                            <input type="text" id="theme-name" placeholder="Ex: Controle de Constitucionalidade" class="w-full p-3 border border-slate-300 rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white dark:placeholder-slate-400" required>
                        </div>
                        <div>
                            <label for="topic-name" class="block text-sm font-medium text-slate-700 dark:text-slate-400 mb-1">Assunto</label>
                            <input type="text" id="topic-name" placeholder="Ex: Conceitos e Caracter√≠sticas" class="w-full p-3 border border-slate-300 rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white dark:placeholder-slate-400" required>
                        </div>
                        <div>
                            <label for="topic-difficulty" class="block text-sm font-medium text-slate-700 dark:text-slate-400 mb-1">Dificuldade do Assunto</label>
                            <select id="topic-difficulty" class="w-full p-3 border border-slate-300 rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                                <option value="F√°cil">F√°cil</option>
                                <option value="M√©dia" selected>M√©dia</option>
                                <option value="Dif√≠cil">Dif√≠cil</option>
                            </select>
                        </div>
                        <div>
                            <label for="cycle-total-questions" class="block text-sm font-medium text-slate-700 dark:text-slate-400 mb-1">Total de Quest√µes no Assunto</label>
                            <input type="number" id="cycle-total-questions" placeholder="50" class="w-full p-3 border border-slate-300 rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white dark:placeholder-slate-400" required>
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-slate-700 dark:text-slate-400 mb-2">Dias de Estudo (para a mat√©ria inteira)</label>
                            <div id="study-days-checkboxes" class="flex flex-wrap gap-x-4 gap-y-2 text-sm">
                                </div>
                        </div>
                        <div class="md:col-span-2">
                            <label for="material-link" class="block text-sm font-medium text-slate-700 dark:text-slate-400 mb-1">Link para Material (Opcional)</label>
                            <input type="url" id="material-link" placeholder="https://..." class="w-full p-3 border border-slate-300 rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white dark:placeholder-slate-400">
                        </div>
                        <div class="md:col-span-2 text-right">
                            <button type="submit" class="w-full md:w-auto bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg mt-2 hover:bg-indigo-700 transition-colors">Adicionar Assunto</button>
                        </div>
                    </form>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-md">
                        <h2 class="text-xl font-semibold mb-2 dark:text-slate-200">Importar de Planilha (.xlsx)</h2>
                        <p class="text-sm text-slate-600 dark:text-slate-400 mb-4">Preencha o modelo para adicionar m√∫ltiplos assuntos.</p>
                        <div class="flex items-center gap-4">
                            <input type="file" id="excel-file-input" accept=".xlsx, .xls" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 dark:file:bg-indigo-900/50 dark:file:text-indigo-300 dark:hover:file:bg-indigo-900">
                        </div>
                        <div class="flex items-center gap-4 mt-4">
                             <button id="download-template-btn" class="w-full bg-sky-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-sky-700 transition-colors">Baixar Modelo</button>
                             <button id="import-excel-btn" class="w-full bg-green-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-green-700 transition-colors">Importar Planilha</button>
                        </div>
                    </div>
                   <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-md">
                        <h2 class="text-xl font-semibold mb-2 dark:text-slate-200">Analisar Edital (.txt)</h2>
                        <p class="text-sm text-slate-600 dark:text-slate-400 mb-4">Carregue um edital .txt para criar seu planejamento.</p>
                          <div class="flex items-center gap-4">
                            <input type="file" id="edital-file-input" accept=".txt" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 dark:file:bg-indigo-900/50 dark:file:text-indigo-300 dark:hover:file:bg-indigo-900">
                          </div>
                          <div class="flex items-center gap-4 mt-4">
                            <button id="download-edital-template-btn" class="w-full bg-sky-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-sky-700 transition-colors">Baixar Modelo (.txt)</button>
                            <button id="import-edital-btn" class="w-full bg-green-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-green-700 transition-colors flex items-center justify-center gap-2">
                                Analisar Edital
                            </button>
                          </div>
                    </div>
                </div>
            </div>

            <div class="bg-white dark:bg-slate-800 p-3 rounded-xl shadow-md flex items-center justify-center gap-1 md:gap-2 flex-wrap mb-8" id="day-filter-bar">
                </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                        <div class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-md border-2 border-slate-200 dark:border-slate-700">
                                       <h2 class="text-md font-semibold mb-2 text-center dark:text-slate-200">Progresso Di√°rio</h2>
                                       <div class="progress-bar-bg w-full h-3 rounded-full overflow-hidden dark:bg-slate-700">
                                            <div id="daily-progress-bar" class="progress-bar-fill h-full bg-green-500" style="width: 0%;"></div>
                                       </div>
                                       <p id="daily-progress-text" class="text-center text-sm font-medium mt-1 dark:text-slate-300">0/0 (0%) da meta definida para o dia</p>
                        </div>
                    <div class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-md border-2 border-slate-200 dark:border-slate-700">
                        <div class="flex justify-center items-center gap-2 mb-2">
                            <h2 class="text-md font-semibold text-center dark:text-slate-200">Revis√µes para Hoje</h2>
                            <button id="calendar-view-btn" class="text-indigo-600 hover:text-indigo-800 dark:text-indigo-400 dark:hover:text-indigo-300">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" /></svg>
                            </button>
                        </div>
                        <div id="reviews-today-container" class="space-y-1 max-h-32 overflow-y-auto p-1">
                                </div>
                        <div id="review-session-starter" class="hidden text-center mt-2">
                            <button id="start-review-session-btn" class="w-full bg-amber-500 text-white font-semibold py-2 px-5 rounded-lg hover:bg-amber-600 transition-colors">Iniciar Sess√£o de Revis√£o</button>
                        </div>
                    </div>
            </div>
        </div>


        <div id="disciplines-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
    </div>

    <div id="modal-backdrop" class="modal-backdrop"></div>
    
    <div id="questions-modal" class="modal bg-white dark:bg-slate-800 p-8 rounded-xl shadow-lg w-11/12 max-w-md">
        <h2 class="text-xl font-bold mb-4 dark:text-slate-200" id="modal-subject-title">Adicionar Quest√µes</h2>
        <form id="add-questions-form">
            <input type="hidden" id="questions-discipline-id">
            <input type="hidden" id="questions-theme-id">
            <input type="hidden" id="questions-topic-id">
            <div class="mb-4">
                <label for="questions-done" class="block text-sm font-medium text-slate-700 dark:text-slate-400 mb-1">Quest√µes Resolvidas</label>
                <input type="number" id="questions-done" class="w-full p-3 border border-slate-300 rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white" required>
            </div>
            <div class="mb-6">
                <label for="questions-correct" class="block text-sm font-medium text-slate-700 dark:text-slate-400 mb-1">Quest√µes Corretas</label>
                <input type="number" id="questions-correct" class="w-full p-3 border border-slate-300 rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white" required>
            </div>
            <div class="flex justify-end gap-3">
                <button type="button" class="close-modal-btn bg-slate-200 text-slate-800 font-semibold py-2 px-5 rounded-lg dark:bg-slate-600 dark:text-slate-300">Cancelar</button>
                <button type="submit" class="bg-indigo-600 text-white font-semibold py-2 px-5 rounded-lg">Salvar</button>
            </div>
        </form>
    </div>
    <div id="review-modal" class="modal bg-white dark:bg-slate-800 p-8 rounded-xl shadow-lg w-11/12 max-w-md text-center">
        <h2 class="text-xl font-bold mb-2 dark:text-slate-200">Revis√£o Conclu√≠da!</h2>
        <p class="text-slate-600 dark:text-slate-400 mb-6">Quando voc√™ quer revisar este assunto novamente?</p>
        <div id="review-options" class="flex flex-wrap justify-center gap-3">
             <button data-days="7" class="review-schedule-btn bg-indigo-500 text-white font-semibold py-2 px-5 rounded-lg">7 Dias</button>
             <button data-days="15" class="review-schedule-btn bg-indigo-500 text-white font-semibold py-2 px-5 rounded-lg">15 Dias</button>
             <button data-days="20" class="review-schedule-btn bg-indigo-500 text-white font-semibold py-2 px-5 rounded-lg">20 Dias</button>
             <button data-days="30" class="review-schedule-btn bg-indigo-500 text-white font-semibold py-2 px-5 rounded-lg">30 Dias</button>
        </div>
          <div class="mt-4 flex flex-col items-center">
            <label for="custom-review-date" class="text-sm text-slate-600 dark:text-slate-400">Ou escolha uma data:</label>
            <input type="date" id="custom-review-date" class="mt-1 p-2 border rounded-lg w-full max-w-xs dark:bg-slate-700 dark:border-slate-600 dark:text-white" style="color-scheme: dark;">
        </div>
        <button class="close-modal-btn text-sm text-slate-500 hover:text-slate-800 mt-6 dark:text-slate-400 dark:hover:text-slate-200">N√£o agendar por enquanto</button>
    </div>
    <div id="notes-modal" class="modal bg-white dark:bg-slate-800 p-8 rounded-xl shadow-lg w-11/12 max-w-2xl">
        <div id="notes-modal-header" class="bg-white dark:bg-slate-800">
            <div id="notes-modal-title">
                <h2 class="text-xl font-bold dark:text-slate-200">Anota√ß√µes</h2>
                <button id="toggle-maximize-notes" class="p-1 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700 text-slate-500 dark:text-slate-400 transition-colors" title="Maximizar/Restaurar">
                    <svg class="w-5 h-5 maximize-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5v-4m0 4h-4m4 0l-5-5"></path></svg>
                    <svg class="w-5 h-5 restore-icon hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 8V4m0 0h4M8 4l5 5m11-1V8m0 0h-4m4 0l-5 5M8 16v4m0 0h4m-4 0l5-5m11 5v-4m0 4h-4m4 0l-5-5"></path></svg>
                </button>
                </div>
            <div id="notes-toolbar" class="flex items-center gap-2 border border-b-0 border-slate-200 bg-slate-50 rounded-t-lg p-2 flex-wrap dark:bg-slate-700 dark:border-slate-600">
                <button data-command="bold" class="note-format-btn font-bold">B</button>
                <button data-command="italic" class="note-format-btn italic">I</button>
                <button data-command="underline" class="note-format-btn underline">U</button>
                <button data-command="strikeThrough" class="note-format-btn line-through">S</button>
                <button data-command="insertUnorderedList" class="note-format-btn">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7"></path></svg>
                </button>
                    <button data-command="removeFormat" class="note-format-btn font-bold text-xs" title="Remover Formata√ß√£o">T<span class="line-through">x</span></button>
                <button id="add-image-btn" class="note-format-btn">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                </button>
                <div class="relative group" title="Cor da Fonte">
                    <button class="note-format-btn">
                        <svg class="w-5 h-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10 4a.75.75 0 01.75.75v10.5a.75.75 0 01-1.5 0V4.75A.75.75 0 0110 4z" /><path fill-rule="evenodd" d="M6.25 1A2.25 2.25 0 004 3.25v13.5A2.25 2.25 0 006.25 19h7.5A2.25 2.25 0 0016 16.75V3.25A2.25 2.25 0 0013.75 1h-7.5zM5.5 3.25a.75.75 0 01.75-.75h7.5a.75.75 0 01.75.75v13.5a.75.75 0 01-.75.75h-7.5a.75.75 0 01-.75-.75V3.25z" clip-rule="evenodd" /></svg>
                        <span class="font-bold">A</span>
                    </button>
                    <div id="font-color-palette" class="hidden group-hover:flex absolute z-10 top-full mt-1 bg-white dark:bg-slate-600 shadow-lg rounded-md p-2 gap-2 w-48 flex-wrap">
                        </div>
                </div>
                    <div class="relative group" title="Cor do Destaque">
                    <button class="note-format-btn">
                        <svg class="w-5 h-5" viewBox="0 0 20 20" fill="currentColor">
                                           <path d="M9.25 1C8.56 1 8 1.56 8 2.25V3.75C8 4.44 8.56 5 9.25 5H10.75C11.44 5 12 4.44 12 3.75V2.25C12 1.56 11.44 1 10.75 1H9.25zM7.5 7.75C7.5 7.06 8.06 6.5 8.75 6.5H11.25C11.94 6.5 12.5 7.06 12.5 7.75V19L10 17L7.5 19V7.75z"/>
                    </svg>
                    </button>
                    <div id="highlight-color-palette" class="hidden group-hover:flex absolute z-10 top-full mt-1 bg-white dark:bg-slate-600 shadow-lg rounded-md p-2 gap-2 w-48 flex-wrap">
                            </div>
                </div>
            </div>
        </div>
        <div class="modal-content-area" style="position: relative; overflow: hidden;">
            <div id="notes-editor" contenteditable="true" class="w-full p-3 border border-slate-200 rounded-b-lg overflow-y-auto focus:outline-none dark:bg-slate-800 dark:border-slate-600 dark:text-slate-300" style="min-height: 20rem;"></div>
            
            <div class="flex justify-end gap-3 mt-4">
                <button type="button" class="close-modal-btn bg-slate-200 text-slate-800 font-semibold py-2 px-5 rounded-lg dark:bg-slate-600 dark:text-slate-300">Cancelar</button>
                <button type="button" id="save-notes-btn" class="bg-indigo-600 text-white font-semibold py-2 px-5 rounded-lg">Salvar</button>
            </div>
        </div>
    </div>
    <div id="edit-topic-modal" class="modal bg-white dark:bg-slate-800 p-8 rounded-xl shadow-lg w-11/12 max-w-lg">
        <h2 class="text-xl font-bold mb-4 dark:text-slate-200" id="edit-topic-modal-title">Editar Assunto</h2>
        <form id="edit-topic-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <input type="hidden" id="edit-discipline-id"> 
            <input type="hidden" id="edit-theme-id">
            <input type="hidden" id="edit-topic-id">
            <div class="md:col-span-2">
                <label for="edit-topic-name" class="block text-sm font-medium text-slate-700 dark:text-slate-400 mb-1">Nome do Assunto</label>
                <input type="text" id="edit-topic-name" class="w-full p-3 border border-slate-300 rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white" required>
            </div>
            <div>
                <label for="edit-topic-difficulty" class="block text-sm font-medium text-slate-700 dark:text-slate-400 mb-1">Dificuldade</label>
                <select id="edit-topic-difficulty" class="w-full p-3 border border-slate-300 rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white"></select>
            </div>
            <div>
                <label for="edit-cycle-total-questions" class="block text-sm font-medium text-slate-700 dark:text-slate-400 mb-1">Total de Quest√µes no Assunto</label>
                <input type="number" id="edit-cycle-total-questions" class="w-full p-3 border border-slate-300 rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white" required>
            </div>
            <div class="md:col-span-2">
                <label for="edit-material-link" class="block text-sm font-medium text-slate-700 dark:text-slate-400 mb-1">Link para Material</label>
                <input type="url" id="edit-material-link" placeholder="https://..." class="w-full p-3 border border-slate-300 rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white">
            </div>
            <div class="md:col-span-2 flex justify-end gap-3 mt-4">
                <button type="button" class="close-modal-btn bg-slate-200 text-slate-800 font-semibold py-2 px-5 rounded-lg dark:bg-slate-600 dark:text-slate-300">Cancelar</button>
                <button type="submit" class="bg-indigo-600 text-white font-semibold py-2 px-5 rounded-lg">Salvar Altera√ß√µes</button>
            </div>
        </form>
    </div>
        <div id="calendar-modal" class="modal bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg w-11/12 max-w-xl"></div>
        <div id="initial-reviews-modal" class="modal bg-white dark:bg-slate-800 p-8 rounded-xl shadow-lg w-11/12 max-w-lg text-center"></div>
    <div id="edit-discipline-modal" class="modal bg-white dark:bg-slate-800 p-8 rounded-xl shadow-lg w-11/12 max-w-lg">
        <h2 class="text-xl font-bold mb-4 dark:text-slate-200" id="edit-discipline-modal-title">Editar Mat√©ria</h2>
        <form id="edit-discipline-form">
            <input type="hidden" id="edit-discipline-modal-id">
            <div class="space-y-4">
                <div>
                    <label for="edit-discipline-modal-name" class="block text-sm font-medium text-slate-700 dark:text-slate-400 mb-1">Nome da Mat√©ria</label>
                    <input type="text" id="edit-discipline-modal-name" class="w-full p-3 border border-slate-300 rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white" required>
                </div>
                <div>
                    <label for="edit-discipline-modal-goal" class="block text-sm font-medium text-slate-700 dark:text-slate-400 mb-1">Meta Di√°ria de Quest√µes</label>
                    <input type="number" id="edit-discipline-modal-goal" class="w-full p-3 border border-slate-300 rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-400 mb-2">Dias de Estudo</label>
                    <div id="edit-discipline-modal-days" class="flex flex-wrap gap-x-4 gap-y-2 text-sm"></div>
                </div>
            </div>
            <div class="flex justify-between items-center mt-6 pt-4 border-t dark:border-slate-700">
                <button type="button" id="add-content-from-edit-btn" class="bg-blue-600 text-white font-semibold py-2 px-5 rounded-lg">Adicionar Tema/Assunto</button>
                <div class="flex gap-3">
                    <button type="button" class="close-modal-btn bg-slate-200 text-slate-800 font-semibold py-2 px-5 rounded-lg dark:bg-slate-600 dark:text-slate-300">Cancelar</button>
                    <button type="submit" class="bg-indigo-600 text-white font-semibold py-2 px-5 rounded-lg">Salvar e Fechar</button>
                </div>
            </div>
        </form>
    </div>

    <div id="cycle-calculator-modal" class="modal bg-white dark:bg-slate-800 p-8 rounded-xl shadow-lg w-11/12 max-w-7xl">
        <h2 class="text-2xl font-bold mb-4 border-b pb-3 dark:text-slate-200 dark:border-slate-700">Calculadora de Ciclo de Estudos</h2>
        <div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <h3 class="text-lg font-semibold mb-3 dark:text-slate-200">Par√¢metros do Ciclo</h3>
                    <div class="space-y-4">
                        <div>
                            <label for="cycle-duration-months" class="block text-sm font-medium text-slate-700 dark:text-slate-400 mb-1">Dura√ß√£o do Ciclo (meses)</label>
                            <input type="number" id="cycle-duration-months" value="1" class="w-full p-2 border border-slate-300 rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                        </div>
                        <div>
                            <label for="cycle-questions-per-day" class="block text-sm font-medium text-slate-700 dark:text-slate-400 mb-1">Total de Quest√µes por Dia de Estudo</label>
                            <input type="number" id="cycle-questions-per-day" value="100" class="w-full p-2 border border-slate-300 rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 dark:text-slate-400 mb-2">Dias de Estudo do Ciclo</label>
                            <div id="cycle-study-days-checkboxes" class="flex flex-wrap gap-x-4 gap-y-2 text-sm">
                                </div>
                        </div>
                    </div>
                    <h3 class="text-lg font-semibold mb-3 mt-6 dark:text-slate-200">Mat√©rias e Pesos</h3>
                            <div class="grid grid-cols-12 gap-2 items-center text-xs text-slate-500 dark:text-slate-400 font-medium mb-1 px-1">
                                <div class="col-span-6">Mat√©ria</div>
                                <div class="col-span-2 text-center">Peso</div>
                                <div class="col-span-2 text-center">x/Semana</div>
                                <div class="col-span-2 text-center">Dificuldade</div>
                            </div>
                    <div id="cycle-disciplines-list" class="space-y-2 max-h-48 overflow-y-auto pr-2">
                        </div>
                    <button id="add-cycle-discipline-btn" class="mt-3 w-full bg-slate-200 text-slate-800 font-semibold py-2 rounded-lg hover:bg-slate-300 dark:bg-slate-700 dark:hover:bg-slate-600">+ Adicionar Mat√©ria</button>
                </div>
                <div>
                    <h3 class="text-lg font-semibold mb-3 dark:text-slate-200">Distribu√ß√£o de Quest√µes</h3>
                            <div id="cycle-results-table" class="bg-slate-50 dark:bg-slate-800/50 p-4 rounded-lg min-h-[200px] max-h-[50vh] overflow-y-auto">
                                <p class="text-slate-500 dark:text-slate-400">Preencha os dados e clique em "Calcular" para ver a distribui√ß√£o.</p>
                            </div>
                           <div id="cycle-total-distributed" class="text-right font-bold mt-2 text-slate-700 dark:text-slate-300"></div>
                </div>
            </div>

            <div id="cycle-schedule-container" class="mt-6 hidden">
                <h3 class="text-lg font-semibold mb-3 dark:text-slate-200">Sugest√£o de Cronograma Semanal</h3>
                <div id="cycle-schedule" class="bg-slate-50 dark:bg-slate-800/50 p-4 rounded-lg overflow-x-auto"></div>
            </div>

        </div>
        <div class="flex justify-end gap-3 mt-6 pt-4 border-t dark:border-slate-700">
            <button type="button" id="clear-cycle-btn" class="bg-slate-200 text-slate-800 font-semibold py-2 px-5 rounded-lg dark:bg-slate-600 dark:text-slate-300">Limpar</button>
            <button type="button" id="calculate-cycle-btn" class="bg-indigo-600 text-white font-semibold py-2 px-5 rounded-lg">Calcular</button>
            <button type="button" id="save-cycle-btn" class="bg-green-600 text-white font-semibold py-2 px-5 rounded-lg">Salvar Ciclo</button>
            <button type="button" class="close-modal-btn bg-slate-200 text-slate-800 font-semibold py-2 px-5 rounded-lg dark:bg-slate-600 dark:text-slate-300">Fechar</button>
        </div>
    </div>

    <div id="stats-modal" class="modal bg-white dark:bg-slate-800 p-8 rounded-xl shadow-lg w-11/12 max-w-5xl">
        <h2 class="text-2xl font-bold mb-4 border-b pb-3 dark:text-slate-200 dark:border-slate-700">Estat√≠sticas de Desempenho</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 bg-slate-50 dark:bg-slate-700/50 p-4 rounded-lg">
            <div>
                <label for="stats-filter-discipline" class="block text-sm font-medium text-slate-700 dark:text-slate-400 mb-1">Mat√©ria</label>
                <select id="stats-filter-discipline" class="w-full p-2 border border-slate-300 rounded-lg text-sm dark:bg-slate-700 dark:border-slate-600 dark:text-white"></select>
            </div>
            <div>
                <label for="stats-filter-theme" class="block text-sm font-medium text-slate-700 dark:text-slate-400 mb-1">Tema</label>
                <select id="stats-filter-theme" class="w-full p-2 border border-slate-300 rounded-lg text-sm dark:bg-slate-700 dark:border-slate-600 dark:text-white"></select>
            </div>
            <div>
                <label for="stats-filter-topic" class="block text-sm font-medium text-slate-700 dark:text-slate-400 mb-1">Assunto</label>
                <select id="stats-filter-topic" class="w-full p-2 border border-slate-300 rounded-lg text-sm dark:bg-slate-700 dark:border-slate-600 dark:text-white"></select>
            </div>
            <div class="md:col-span-3 grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                <div>
                    <label for="stats-filter-start-date" class="block text-sm font-medium text-slate-700 dark:text-slate-400 mb-1">Data In√≠cio</label>
                    <input type="date" id="stats-filter-start-date" class="w-full p-2 border border-slate-300 rounded-lg text-sm dark:bg-slate-700 dark:border-slate-600 dark:text-white" style="color-scheme: dark;">
                </div>
                <div>
                    <label for="stats-filter-end-date" class="block text-sm font-medium text-slate-700 dark:text-slate-400 mb-1">Data Fim</label>
                    <input type="date" id="stats-filter-end-date" class="w-full p-2 border border-slate-300 rounded-lg text-sm dark:bg-slate-700 dark:border-slate-600 dark:text-white" style="color-scheme: dark;">
                </div>
                <button id="stats-apply-filters-btn" class="bg-indigo-600 text-white font-semibold py-2 px-5 rounded-lg w-full">Aplicar Filtros</button>
            </div>
        </div>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div>
                <h3 class="text-lg font-semibold text-center mb-2 dark:text-slate-200">Desempenho de Acertos (no per√≠odo)</h3>
                <div class="relative h-80">
                    <canvas id="stats-pie-chart"></canvas>
                </div>
            </div>
            <div>
                <h3 class="text-lg font-semibold text-center mb-2 dark:text-slate-200">Quest√µes Feitas ao Longo do Tempo</h3>
                    <div class="relative h-80">
                    <canvas id="stats-line-chart"></canvas>
                </div>
            </div>
        </div>
        <div class="flex justify-end gap-3 mt-6 pt-4 border-t dark:border-slate-700">
            <button type="button" class="close-modal-btn bg-slate-200 text-slate-800 font-semibold py-2 px-5 rounded-lg dark:bg-slate-600 dark:text-slate-300">Fechar</button>
        </div>
    </div>
    
    <div id="critical-subjects-modal" class="modal bg-white dark:bg-slate-800 p-8 rounded-xl shadow-lg w-11/12 max-w-4xl">
        <h2 class="text-2xl font-bold mb-4 border-b pb-3 dark:text-slate-200 dark:border-slate-700">An√°lise Cr√≠tica</h2>
        <p class="text-slate-600 dark:text-slate-400 mb-6">Analise seu desempenho por mat√©ria, tema ou assunto para identificar pontos fracos.</p>
        
        <div id="critical-analysis-controls" class="flex justify-center gap-4 mb-6 bg-slate-100 dark:bg-slate-700 p-2 rounded-lg">
             <label class="flex items-center gap-2 cursor-pointer">
                 <input type="radio" name="analysis-level" value="discipline" class="form-radio text-indigo-600 dark:bg-slate-600 dark:border-slate-500" checked> Mat√©rias
             </label>
             <label class="flex items-center gap-2 cursor-pointer">
                 <input type="radio" name="analysis-level" value="theme" class="form-radio text-indigo-600 dark:bg-slate-600 dark:border-slate-500"> Temas
             </label>
             <label class="flex items-center gap-2 cursor-pointer">
                 <input type="radio" name="analysis-level" value="topic" class="form-radio text-indigo-600 dark:bg-slate-600 dark:border-slate-500"> Assuntos
             </label>
        </div>

        <div id="critical-subjects-list" class="space-y-3 max-h-80 overflow-y-auto">
            </div>
        <div class="flex justify-end gap-3 mt-6 pt-4 border-t dark:border-slate-700">
            <button type="button" class="close-modal-btn bg-slate-200 text-slate-800 font-semibold py-2 px-5 rounded-lg dark:bg-slate-600 dark:text-slate-300">Fechar</button>
        </div>
    </div>

    <div id="review-session-modal" class="modal bg-white dark:bg-slate-800 p-8 rounded-xl shadow-lg w-11/12 max-w-3xl">
        <div id="review-session-content">
            </div>
        <div class="flex justify-end gap-3 mt-6 pt-4 border-t dark:border-slate-700">
            <button type="button" class="close-modal-btn bg-slate-200 text-slate-800 font-semibold py-2 px-5 rounded-lg dark:bg-slate-600 dark:text-slate-300">Fechar</button>
        </div>
    </div>
    
    <div id="edital-preview-modal" class="modal bg-white dark:bg-slate-800 p-8 rounded-xl shadow-lg w-11/12 max-w-4xl">
        <h2 class="text-2xl font-bold mb-4 border-b pb-3 dark:text-slate-200 dark:border-slate-700">Pr√©-visualiza√ß√£o do Edital</h2>
        <p class="text-slate-600 dark:text-slate-400 mb-6">Confira a estrutura extra√≠da do edital. Se estiver correto, clique em "Salvar Planejamento".</p>
        <div id="edital-preview-content" class="space-y-4 max-h-96 overflow-y-auto bg-slate-50 dark:bg-slate-800/50 p-4 rounded-lg">
            </div>
        <div class="flex justify-end gap-3 mt-6 pt-4 border-t dark:border-slate-700">
            <button type="button" class="close-modal-btn bg-slate-200 text-slate-800 font-semibold py-2 px-5 rounded-lg dark:bg-slate-600 dark:text-slate-300">Cancelar</button>
            <button type="button" id="save-edital-plan-btn" class="bg-green-600 text-white font-semibold py-2 px-5 rounded-lg">Salvar Planejamento</button>
        </div>
    </div>

    <div id="subject-questions-modal" class="modal bg-white dark:bg-slate-800 p-8 rounded-xl shadow-lg w-11/12 max-w-3xl">
        <h2 class="text-2xl font-bold mb-4 border-b pb-3 dark:text-slate-200 dark:border-slate-700" id="subject-questions-modal-title">Distribuir Quest√µes</h2>
        <div id="subject-questions-modal-content" class="space-y-3 max-h-[60vh] overflow-y-auto pr-2">
            </div>
        <div class="flex justify-end gap-3 mt-6 pt-4 border-t dark:border-slate-700">
            <button type="button" class="close-modal-btn bg-slate-200 text-slate-800 font-semibold py-2 px-5 rounded-lg dark:bg-slate-600 dark:text-slate-300">Cancelar</button>
            <button type="button" id="save-subject-questions-btn" class="bg-green-600 text-white font-semibold py-2 px-5 rounded-lg">Salvar e Atualizar</button>
        </div>
    </div>

    <div id="planning-modal" class="modal bg-white dark:bg-slate-800 p-8 rounded-xl shadow-lg w-11/12 max-w-6xl">
        <h2 class="text-2xl font-bold mb-4 border-b pb-3 dark:text-slate-200 dark:border-slate-700">üóìÔ∏è Planejamento Semanal (Vis√£o Sint√©tica)</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div>
                <label for="planning-filter-discipline" class="block text-sm font-medium text-slate-700 dark:text-slate-400 mb-1">Mat√©ria (Filtro)</label>
                <select id="planning-filter-discipline" class="w-full p-2 border border-slate-300 rounded-lg text-sm dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                    <option value="">Todas as Mat√©rias</option>
                </select>
            </div>
              <div class="md:col-span-2">
                <label for="planning-week-selector" class="block text-sm font-medium text-slate-700 dark:text-slate-400 mb-1">Semana (Filtro)</label>
                <div class="flex gap-2 items-center">
                    <button id="prev-week-btn" class="p-2 rounded-lg bg-slate-200 hover:bg-slate-300 dark:bg-slate-700 dark:hover:bg-slate-600 dark:text-slate-300">&lt;</button>
                    <input type="week" id="planning-week-selector" class="w-full p-2 border border-slate-300 rounded-lg text-sm dark:bg-slate-700 dark:border-slate-600 dark:text-white" style="color-scheme: dark;">
                    <button id="next-week-btn" class="p-2 rounded-lg bg-slate-200 hover:bg-slate-300 dark:bg-slate-700 dark:hover:bg-slate-600 dark:text-slate-300">&gt;</button>
                </div>
            </div>
        </div>

        <div id="planning-view-content" class="space-y-6">
            <div id="planning-weekly-calendar" class="bg-slate-50 dark:bg-slate-700/50 p-4 rounded-lg overflow-x-auto min-h-[150px]">
                <p class="text-slate-500 dark:text-slate-400 text-center">Carregando planejamento...</p>
            </div>

            <h3 class="text-lg font-semibold border-b pb-2 dark:text-slate-200 dark:border-slate-700">Resumo Semanal por Mat√©ria</h3>
            <div id="planning-weekly-summary" class="bg-slate-50 dark:bg-slate-700/50 p-4 rounded-lg overflow-x-auto min-h-[100px]">
                <p class="text-slate-500 dark:text-slate-400 text-center">O resumo ser√° exibido aqui.</p>
            </div>
        </div>

        <div class="flex justify-end gap-3 mt-6 pt-4 border-t dark:border-slate-700">
            <button type="button" class="close-modal-btn bg-slate-200 text-slate-800 font-semibold py-2 px-5 rounded-lg dark:bg-slate-600 dark:text-slate-300">Fechar</button>
        </div>
    </div>
    <script>
// =========================================================================
// IN√çCIO DO SCRIPT JAVASCRIPT COMPLETO E CORRIGIDO (V11)
// =========================================================================
document.addEventListener('DOMContentLoaded', () => {
    // Verifica se localforage foi carregado
    if (typeof localforage === 'undefined') {
        alert("Erro cr√≠tico: A biblioteca localforage (IndexedDB) n√£o foi carregada. Verifique a conex√£o ou a inclus√£o do script.");
        return;
    }
    
    // Configura o localforage para usar a melhor tecnologia (IndexedDB)
    localforage.config({
        name: 'StudyManagerApp',
        storeName: 'StudyDataStore',
        version: 1.0,
        description: 'Armazenamento de dados do Gerenciador de Estudos'
    });

    let disciplines = [];
    let dailyQuestionsTotal = 0;
    let questionHistory = [];
    let notesLibrary = {}; // Biblioteca global de anota√ß√µes por nome de assunto
    let activeModal = null;
    let activeTopicIds = { disciplineId: null, themeId: null, topicId: null };
    let currentDayFilter = new Date().getDay();
    let openDisciplines = new Set();
    let openThemes = new Set();
    let selectedDisciplineId = null;
    let lastCycleResults = null;
    let lastCycleSchedule = null;
    let statsPieChart = null;
    let statsLineChart = null;
    let timers = {};
    let reviewSessionState = { active: false, reviews: [], currentIndex: -1 };
    let tempEditalData = null; 
    let currentPlanningWeek = getCurrentWeekString(); 


    window.miniCharts = {}; 

    const difficultyMap = {
        'F√°cil': 'bg-green-100 text-green-800 dark:bg-green-900/50 dark:text-green-300', 
        'M√©dia': 'bg-amber-100 text-amber-800 dark:bg-amber-900/50 dark:text-amber-300', 
        'Dif√≠cil': 'bg-red-100 text-red-800 dark:bg-red-900/50 dark:text-red-300',
    };
    const difficultyOptions = ['F√°cil', 'M√©dia', 'Dif√≠cil'];
    const weekDays = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'];
    const weekDaysMap = {'dom': 0, 'seg': 1, 'ter': 2, 'qua': 3, 'qui': 4, 'sex': 5, 'sab': 6};

    const getChartColors = () => {
        const isDarkMode = document.documentElement.classList.contains('dark');
        return {
            textColor: isDarkMode ? '#CBD5E1' : '#475569',
            gridColor: isDarkMode ? 'rgba(71, 85, 105, 0.5)' : 'rgba(203, 213, 224, 0.5)'
        };
    };

    const getToday = () => { 
        const today = new Date(); 
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const day = String(today.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    };

    const getLocalDateObject = (dateString) => {
        if (!dateString) return null;
        const [year, month, day] = dateString.split('-').map(Number);
        const date = new Date(year, month - 1, day); 
        date.setHours(0, 0, 0, 0);
        return date;
    };
    
    const addDays = (date, days) => { 
        const result = getLocalDateObject(date); 
        if (!result) return null;
        result.setDate(result.getDate() + days); 
        const year = result.getFullYear();
        const month = String(result.getMonth() + 1).padStart(2, '0');
        const day = String(result.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    };
    
    function getCurrentWeekString() {
        const date = new Date();
        const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
        const dayNum = d.getUTCDay() || 7;
        d.setUTCDate(d.getUTCDate() + 4 - dayNum);
        const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
        const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        return d.getUTCFullYear() + '-W' + String(weekNo).padStart(2, '0');
    }

    const calculateTodayTotal = (history, todayStr) => {
        return history
            .filter(item => item.date === todayStr)
            .reduce((sum, item) => sum + (item.done || 0), 0);
    };

    const DOM = {
        html: document.documentElement,
        disciplinesContainer: document.getElementById('disciplines-container'),
        addTopicForm: document.getElementById('add-topic-form'),
        disciplineSelect: document.getElementById('discipline-select'),
        addNewDisciplineBtn: document.getElementById('add-new-discipline-btn'),
        reviewsTodayContainer: document.getElementById('reviews-today-container'),
        dailyProgressBar: document.getElementById('daily-progress-bar'),
        dailyProgressText: document.getElementById('daily-progress-text'),
        modalBackdrop: document.getElementById('modal-backdrop'),
        editalFileInput: document.getElementById('edital-file-input'),
        importEditalBtn: document.getElementById('import-edital-btn'),
        excelFileInput: document.getElementById('excel-file-input'),
        importExcelBtn: document.getElementById('import-excel-btn'),
        downloadTemplateBtn: document.getElementById('download-template-btn'),
        downloadEditalTemplateBtn: document.getElementById('download-edital-template-btn'),
        dayFilterBar: document.getElementById('day-filter-bar'),
        studyDaysCheckboxes: document.getElementById('study-days-checkboxes'),
        toggleFormBtn: document.getElementById('toggle-form-btn'),
        toggleableContent: document.getElementById('toggleable-content'),
        calendarViewBtn: document.getElementById('calendar-view-btn'),
        calendarModal: document.getElementById('calendar-modal'),
        initialReviewsModal: document.getElementById('initial-reviews-modal'),
        clearAllBtn: document.getElementById('clear-all-btn'),
        globalSearch: document.getElementById('global-search'),
        criticalSubjectsBtn: document.getElementById('critical-subjects-btn'),
        criticalSubjectsModal: document.getElementById('critical-subjects-modal'),
        criticalSubjectsList: document.getElementById('critical-subjects-list'),
        criticalAnalysisControls: document.getElementById('critical-analysis-controls'),
        reviewSessionStarter: document.getElementById('review-session-starter'),
        startReviewSessionBtn: document.getElementById('start-review-session-btn'),
        reviewSessionModal: document.getElementById('review-session-modal'),
        reviewSessionContent: document.getElementById('review-session-content'),
        editalPreviewModal: document.getElementById('edital-preview-modal'),
        editalPreviewContent: document.getElementById('edital-preview-content'),
        saveEditalPlanBtn: document.getElementById('save-edital-plan-btn'),
        questionsModal: {
            modal: document.getElementById('questions-modal'), form: document.getElementById('add-questions-form'),
            title: document.getElementById('modal-subject-title'), disciplineId: document.getElementById('questions-discipline-id'),
            themeId: document.getElementById('questions-theme-id'),
            topicId: document.getElementById('questions-topic-id'), done: document.getElementById('questions-done'),
            correct: document.getElementById('questions-correct'),
        },
        reviewModal: { 
            modal: document.getElementById('review-modal'), 
            options: document.getElementById('review-options'),
            customDate: document.getElementById('custom-review-date'),
        },
        notesModal: {
            modal: document.getElementById('notes-modal'), title: document.getElementById('notes-modal-title'),
            editor: document.getElementById('notes-editor'), saveBtn: document.getElementById('save-notes-btn'),
            // -- ALTERA√á√ÉO: MAXIMIZAR MODAL --
            toggleMaximizeBtn: document.getElementById('toggle-maximize-notes')
            // ----------------------------------
        },
        editTopicModal: {
            modal: document.getElementById('edit-topic-modal'), form: document.getElementById('edit-topic-form'),
            disciplineId: document.getElementById('edit-discipline-id'), 
            themeId: document.getElementById('edit-theme-id'),
            topicId: document.getElementById('edit-topic-id'),
            name: document.getElementById('edit-topic-name'), difficulty: document.getElementById('edit-topic-difficulty'),
            totalQuestions: document.getElementById('edit-cycle-total-questions'),
            materialLink: document.getElementById('edit-material-link'),
        },
        editDisciplineModal: {
            modal: document.getElementById('edit-discipline-modal'),
            form: document.getElementById('edit-discipline-form'),
            title: document.getElementById('edit-discipline-modal-title'),
            id: document.getElementById('edit-discipline-modal-id'),
            name: document.getElementById('edit-discipline-modal-name'),
            goal: document.getElementById('edit-discipline-modal-goal'),
            days: document.getElementById('edit-discipline-modal-days'),
            addContentBtn: document.getElementById('add-content-from-edit-btn')
        },
        cycleCalculator: {
            btn: document.getElementById('cycle-calculator-btn'),
            modal: document.getElementById('cycle-calculator-modal'),
            duration: document.getElementById('cycle-duration-months'),
            questionsPerDay: document.getElementById('cycle-questions-per-day'),
            studyDaysCheckboxes: document.getElementById('cycle-study-days-checkboxes'), 
            list: document.getElementById('cycle-disciplines-list'),
            addBtn: document.getElementById('add-cycle-discipline-btn'),
            calculateBtn: document.getElementById('calculate-cycle-btn'),
            clearBtn: document.getElementById('clear-cycle-btn'),
            saveBtn: document.getElementById('save-cycle-btn'),
            resultsTable: document.getElementById('cycle-results-table'),
            totalDistributed: document.getElementById('cycle-total-distributed'),
            scheduleContainer: document.getElementById('cycle-schedule-container'),
            schedule: document.getElementById('cycle-schedule'),
        },
        stats: {
            btn: document.getElementById('stats-btn'),
            modal: document.getElementById('stats-modal'),
            filterDiscipline: document.getElementById('stats-filter-discipline'),
            filterTheme: document.getElementById('stats-filter-theme'),
            filterTopic: document.getElementById('stats-filter-topic'),
            filterStartDate: document.getElementById('stats-filter-start-date'),
            filterEndDate: document.getElementById('stats-filter-end-date'),
            applyFiltersBtn: document.getElementById('stats-apply-filters-btn'),
            pieChartCanvas: document.getElementById('stats-pie-chart'),
            lineChartCanvas: document.getElementById('stats-line-chart'),
        },
        subjectQuestionsModal: {
            modal: document.getElementById('subject-questions-modal'),
            title: document.getElementById('subject-questions-modal-title'),
            content: document.getElementById('subject-questions-modal-content'),
            saveBtn: document.getElementById('save-subject-questions-btn')
        },
        planning: {
            btn: document.getElementById('planning-btn'),
            modal: document.getElementById('planning-modal'),
            filterDiscipline: document.getElementById('planning-filter-discipline'),
            weekSelector: document.getElementById('planning-week-selector'),
            prevWeekBtn: document.getElementById('prev-week-btn'),
            nextWeekBtn: document.getElementById('next-week-btn'),
            calendarContent: document.getElementById('planning-weekly-calendar'),
            summaryContent: document.getElementById('planning-weekly-summary'),
        }
    };
    

    // =========================================================================
    // FUN√á√ïES DE PERSIST√äNCIA (localForage/IndexedDB)
    // =========================================================================

    const saveData = async () => {
        const timersToSave = {};
        for (const dId in timers) {
            const timer = timers[dId];
            if (timer.time > 0 || timer.isRunning) { 
                timersToSave[dId] = {
                    time: timer.time,
                    isRunning: timer.isRunning
                };
            }
        }

 const dataToSave = {
            disciplines,
            questionHistory,
            dailyProgress: { date: getToday(), total: 0 }, 
            timers: timersToSave,
            notesLibrary // Isso garante que a biblioteca de notas seja salva
        };

        try {
            await localforage.setItem('studyDataV10', dataToSave);
        } catch (e) {
            console.error("ERRO CR√çTICO AO SALVAR DADOS NO INDEXEDDB:", e);
            alert("Erro ao salvar dados. Seu armazenamento local pode estar cheio ou corrompido. Consulte o console.");
        }
    };

const loadData = async () => {
        const todayStr = getToday();
        let data = null;
        try {
            // Tenta carregar da gaveta principal (V10)
            data = await localforage.getItem('studyDataV10');
            
            // Se a gaveta principal estiver vazia ou com quase nada, tenta a gaveta de backup
            if (!data || (data.disciplines && data.disciplines.length <= 1)) {
                const backupData = await localforage.getItem('studyDataV11_Full');
                if (backupData && backupData.disciplines && backupData.disciplines.length > 1) {
                    data = backupData;
                }
            }
        } catch (e) {
            console.error("ERRO ao carregar dados do IndexedDB.", e);
        }

        if (data && data.disciplines) {
            disciplines = data.disciplines;
            questionHistory = data.questionHistory || [];
            notesLibrary = data.notesLibrary || {};

            // SCANNER: Ele l√™ todo o seu planejamento enorme e "puxa" as notas para a mem√≥ria global
            disciplines.forEach(d => {
                if (d.themes) {
                    d.themes.forEach(th => {
                        th.topics.forEach(t => {
                            if (t.notes && t.notes.trim() !== "" && t.notes !== "<br>") {
                                const key = t.name.trim().toLowerCase();
                                if (!notesLibrary[key]) {
                                    notesLibrary[key] = t.notes; // Memoriza a nota
                                }
                            }
                        });
                    });
                }
            });
            
            dailyQuestionsTotal = calculateTodayTotal(questionHistory, todayStr);
        }
    };

    // =========================================================================
    // FIM DAS FUN√á√ïES DE PERSIST√äNCIA
    // =========================================================================


    const openModal = (modal) => { 
        if(activeModal) {
            modal.style.zIndex = parseInt(activeModal.style.zIndex || 50) + 2;
            DOM.modalBackdrop.style.zIndex = parseInt(activeModal.style.zIndex || 50) + 1;
        } else {
            modal.style.zIndex = 50;
            DOM.modalBackdrop.style.zIndex = 40;
        }
        activeModal = modal; 
        DOM.modalBackdrop.style.display = 'block'; 
        modal.style.display = 'block'; 
    };
    const closeModal = () => { 
        if (!activeModal) return;
        
        // Encontra o modal subjacente que est√° aberto, excluindo o modal ativo atual
        const underlyingModal = Array.from(document.querySelectorAll('.modal')).find(m => m.style.display === 'block' && m !== activeModal);

        activeModal.style.display = 'none';

        // -- ALTERA√á√ÉO: MAXIMIZAR MODAL --
        // Garante que o modal de notas volte ao tamanho normal ao fechar
        if(activeModal.id === 'notes-modal' && activeModal.classList.contains('maximized')) {
             activeModal.classList.remove('maximized');
             activeModal.querySelector('.maximize-icon').classList.remove('hidden');
             activeModal.querySelector('.restore-icon').classList.add('hidden');
        }
        // ----------------------------------

        if (underlyingModal) {
            activeModal = underlyingModal;
            DOM.modalBackdrop.style.zIndex = parseInt(activeModal.style.zIndex) - 1;
        } else {
            DOM.modalBackdrop.style.display = 'none';
            activeModal = null;
        }
    };

    const getTopic = (dId, thId, tId) => {
        // CORRE√á√ÉO: Garante que a busca seja feita comparando strings, que √© o formato salvo
        const discipline = disciplines.find(d => String(d.id) === String(dId));
        if (!discipline || !discipline.themes) return null;
        const theme = discipline.themes.find(th => String(th.id) === String(thId));
        if (!theme || !theme.topics) return null;
        return theme.topics.find(t => String(t.id) === String(tId));
    };
    
    const renderAll = async (searchTerm = '') => { 
        renderDashboard(); 
        renderDisciplines(searchTerm); 
        populateDisciplineSelect(); 
        renderDayFilterBar(); 
        renderStudyDaysCheckboxes(); 
    };

    const renderDashboard = () => {
        const todayStr = getToday();
        const dayForGoal = currentDayFilter === -1 ? new Date().getDay() : currentDayFilter;
        
        dailyQuestionsTotal = calculateTodayTotal(questionHistory, todayStr);

        const totalDailyGoal = disciplines
            .filter(d => d.studyDays && d.studyDays.includes(dayForGoal))
            .reduce((sum, d) => sum + (d.dailyGoal || 0), 0);
        
        let dailyProgressPercentage = totalDailyGoal > 0 ? Math.min((dailyQuestionsTotal / totalDailyGoal) * 100, 100) : 0;

        let colorClass = 'bg-slate-300 dark:bg-slate-600';
        if (totalDailyGoal > 0) {
            if (dailyProgressPercentage < 50) {
                colorClass = 'bg-red-500';
            } else if (dailyProgressPercentage >= 50 && dailyProgressPercentage < 80) {
                colorClass = 'bg-amber-500';
            } else if (dailyProgressPercentage >= 80) {
                colorClass = 'bg-green-500';
            }
        }

        DOM.dailyProgressBar.className = `progress-bar-fill h-full ${colorClass}`;
        DOM.dailyProgressBar.style.width = `${dailyProgressPercentage}%`;
        
        const displayPercentage = totalDailyGoal > 0 ? dailyProgressPercentage.toFixed(0) : 0;
        DOM.dailyProgressText.textContent = `${dailyQuestionsTotal}/${totalDailyGoal} (${displayPercentage}%) da meta definida para o dia`;


        DOM.reviewsTodayContainer.innerHTML = '';
        const today = getToday();
        const allTopics = disciplines.flatMap(d => (d.themes || []).flatMap(th => (th.topics || []).map(t => ({...t, disciplineId: d.id, themeId: th.id, disciplineName: d.name}))));
        const reviewsToday = allTopics.filter(t => t.nextReviewDate && getLocalDateObject(t.nextReviewDate) <= getLocalDateObject(today));

        if (reviewsToday.length === 0) {
            DOM.reviewsTodayContainer.innerHTML = '<p class="text-sm text-slate-500 dark:text-slate-400 text-center pt-4">Nenhuma revis√£o para hoje.</p>';
            DOM.reviewSessionStarter.classList.add('hidden');
        } else {
            DOM.reviewSessionStarter.classList.remove('hidden');
            reviewsToday.forEach(topic => {
                const reviewDate = getLocalDateObject(topic.nextReviewDate);
                const todayDate = getLocalDateObject(today);
                const isOverdue = reviewDate.getTime() < todayDate.getTime();
                const el = document.createElement('div');
                el.className = `p-2 rounded-md text-sm ${isOverdue ? 'bg-red-100 text-red-800 dark:bg-red-900/50 dark:text-red-300' : 'bg-amber-100 text-amber-800 dark:bg-amber-900/50 dark:text-amber-300'}`;
                el.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="font-semibold">${topic.name}</p>
                            <p class="text-xs text-slate-600 dark:text-slate-400">${topic.disciplineName} - Venceu em ${reviewDate.toLocaleDateString()}</p>
                        </div>
                        <button class="dismiss-review-btn p-1 rounded-full hover:bg-red-200 dark:hover:bg-red-900" title="Dispensar esta revis√£o" data-d-id="${topic.disciplineId}" data-th-id="${topic.themeId}" data-t-id="${topic.id}">
                            <svg class="w-4 h-4 text-red-600 dark:text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                    </div>`;
                DOM.reviewsTodayContainer.appendChild(el);
            });
        }
    };
    
    const populateDisciplineSelect = () => {
        const currentVal = DOM.disciplineSelect.value;
        DOM.disciplineSelect.innerHTML = '<option value="" disabled selected>Selecione a Mat√©ria</option>';
        disciplines.forEach(d => {
            const option = document.createElement('option');
            option.value = d.id; option.textContent = d.name;
            DOM.disciplineSelect.appendChild(option);
        });
        if(disciplines.some(d => String(d.id) === String(currentVal))) {
            DOM.disciplineSelect.value = currentVal;
        }
    };

    const highlightStudyDays = (disciplineId) => {
        const buttons = DOM.dayFilterBar.querySelectorAll('.day-filter-btn');
        buttons.forEach((btn) => {
            btn.classList.remove('highlight');
        });

        if (!disciplineId) return;

        const discipline = disciplines.find(d => String(d.id) === String(disciplineId));
        if (discipline && discipline.studyDays) {
            discipline.studyDays.forEach(dayIndex => {
                const btn = DOM.dayFilterBar.querySelector(`[data-day-index="${dayIndex}"]`);
                if (btn && !btn.classList.contains('active')) {
                   btn.classList.add('highlight');
                }
            });
        }
    };


    const renderDayFilterBar = () => {
        DOM.dayFilterBar.innerHTML = '';
        const allBtn = document.createElement('button');
        allBtn.textContent = 'Todos';
        allBtn.className = 'day-filter-btn px-3 py-1.5 text-sm font-semibold rounded-md bg-slate-200 hover:bg-slate-300 dark:bg-slate-700 dark:hover:bg-slate-600 dark:text-slate-300';
        allBtn.dataset.dayIndex = -1;
        if (currentDayFilter === -1) allBtn.classList.add('active', 'dark:bg-indigo-500', 'dark:text-white');
        allBtn.addEventListener('click', () => { 
            currentDayFilter = -1; 
            selectedDisciplineId = null;
            renderAll(); 
        });
        DOM.dayFilterBar.appendChild(allBtn);
        weekDays.forEach((day, index) => {
            const btn = document.createElement('button');
            btn.textContent = day;
            btn.className = 'day-filter-btn px-3 py-1.5 text-sm font-semibold rounded-md bg-slate-200 hover:bg-slate-300 dark:bg-slate-700 dark:hover:bg-slate-600 dark:text-slate-300';
            btn.dataset.dayIndex = index;
            if (currentDayFilter === index) btn.classList.add('active', 'dark:bg-indigo-500', 'dark:text-white');
            btn.addEventListener('click', () => { 
                currentDayFilter = index; 
                selectedDisciplineId = null;
                renderAll(); 
            });
            DOM.dayFilterBar.appendChild(btn);
        });
        highlightStudyDays(selectedDisciplineId);
    };

    const renderStudyDaysCheckboxes = (disciplineId = null) => {
        DOM.studyDaysCheckboxes.innerHTML = '';
        const discipline = disciplineId ? disciplines.find(d => String(d.id) === String(disciplineId)) : null;
        const scheduledDays = discipline ? discipline.studyDays : [];
        weekDays.forEach((day, index) => {
            const label = document.createElement('label');
            label.className = 'flex items-center gap-2 cursor-pointer';
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox'; checkbox.value = index;
            checkbox.className = 'h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 dark:bg-slate-600 dark:border-slate-500';
            if (scheduledDays.includes(index)) checkbox.checked = true;
            label.appendChild(checkbox);
            label.append(day);
            DOM.studyDaysCheckboxes.appendChild(label);
        });
    };

    const calculateStats = (topics) => {
        const totalQuestions = topics.reduce((sum, t) => sum + (t?.cycle?.totalQuestions || 0), 0);
        const questionsDone = topics.reduce((sum, t) => sum + (t?.progress?.done || 0), 0);
        const questionsLeft = totalQuestions - questionsDone;
        const progress = totalQuestions > 0 ? (questionsDone / totalQuestions * 100) : 0;
        return { totalQuestions, questionsDone, questionsLeft, progress };
    };

    const calculateCycleEnd = (discipline) => {
        const allTopics = (discipline.themes || []).flatMap(th => th.topics || []);
        const stats = calculateStats(allTopics);
        if (stats.questionsLeft <= 0) return 'Conclu√≠do!';
        const dailyGoal = discipline.dailyGoal || 0;
        const studyDaysPerWeek = discipline.studyDays ? discipline.studyDays.length : 0;
        if (dailyGoal <= 0 || studyDaysPerWeek <= 0) return 'Definir metas';
        
        const questionsPerWeek = dailyGoal * studyDaysPerWeek;
        if (questionsPerWeek <= 0) return 'Definir metas';

        const weeksToFinish = stats.questionsLeft / questionsPerWeek;
        
        if (weeksToFinish < 1) {
            const studyDaysNeeded = Math.ceil(stats.questionsLeft / dailyGoal);
            return `${studyDaysNeeded} dia(s) de estudo`;
        }
        
        const monthsToFinish = weeksToFinish / 4.345;
        if (monthsToFinish < 1) {
            return `${weeksToFinish.toFixed(1).replace('.', ',')} semana(s)`;
        }
        return `${monthsToFinish.toFixed(1).replace('.', ',')} mese(s)`;
    };


    const renderDisciplines = (searchTerm = '') => {
        const normalizedSearch = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        for (const id in window.miniCharts) {
            if (window.miniCharts[id]) {
                window.miniCharts[id].destroy();
            }
        }
        window.miniCharts = {};

        DOM.disciplinesContainer.innerHTML = '';
        const todayStr = getToday();
        
        let filteredDisciplines = disciplines.filter(d => d && d.themes);
        
        filteredDisciplines = currentDayFilter === -1 
            ? filteredDisciplines 
            : filteredDisciplines.filter(d => d.studyDays && d.studyDays.includes(currentDayFilter));

        let hasSearchResults = false;
        if (normalizedSearch) {
            const tempFilteredDisciplines = [];
            filteredDisciplines.forEach(discipline => {
                const isDisciplineMatch = discipline.name?.toLowerCase()?.normalize("NFD")?.replace(/[\u0300-\u036f]/g, "")?.includes(normalizedSearch);
                
                let themesMatch = [];
                (discipline.themes || []).forEach(theme => {
                    const isThemeMatch = theme.name?.toLowerCase()?.normalize("NFD")?.replace(/[\u0300-\u036f]/g, "")?.includes(normalizedSearch);
                    
                    let topicsMatch = (theme.topics || []).filter(topic => 
                        topic?.name?.toLowerCase()?.normalize("NFD")?.replace(/[\u0300-\u036f]/g, "")?.includes(normalizedSearch)
                    );

                    if (isThemeMatch || topicsMatch.length > 0) {
                        themesMatch.push({ ...theme, topics: topicsMatch.length > 0 ? topicsMatch : theme.topics });
                        hasSearchResults = true;
                    }
                });
                
                if (isDisciplineMatch || themesMatch.length > 0) {
                    tempFilteredDisciplines.push({ ...discipline, themes: themesMatch.length > 0 ? themesMatch : discipline.themes });
                    hasSearchResults = true;
                }
            });
            filteredDisciplines = tempFilteredDisciplines;
        }


        if (filteredDisciplines.length === 0) {
            DOM.disciplinesContainer.innerHTML = `<div class="text-center sm:col-span-2 lg:col-span-3 py-12 bg-white dark:bg-slate-800 rounded-xl shadow-md"><h3 class="text-xl font-semibold text-slate-700 dark:text-slate-300">Nenhum resultado encontrado.</h3><p class="text-slate-500 dark:text-slate-400 mt-2">Altere o filtro de dia ou o termo de busca.</p></div>`;
            return;
        }

        filteredDisciplines.forEach(d => {
            if (!d.themes) d.themes = [];
            if (d.themes.length === 0) return; 
            
            const questionsDoneTodayInDiscipline = questionHistory.filter(item => 
                String(item.date) === todayStr && String(item.disciplineId) == String(d.id)
            ).reduce((sum, item) => sum + (item.done || 0), 0);

            const disciplineCompletedTodayClass = questionsDoneTodayInDiscipline > 0 ? 'completed-today' : 'shadow-lg';


            const allDisciplineTopics = d.themes.flatMap(th => th.topics || []);
            const disciplineStats = calculateStats(allDisciplineTopics);
            const cycleEndText = calculateCycleEnd(d);
            
            const disciplineEl = document.createElement('div');
            disciplineEl.className = `bg-white dark:bg-slate-800 rounded-xl flex flex-col hover:shadow-xl transition-shadow duration-300 overflow-hidden discipline-card ${disciplineCompletedTodayClass}`;

            const header = document.createElement('div');
            header.className = 'p-3 flex flex-col justify-between'; 

            const chartCanvasId = `discipline-chart-${d.id}`;
            const progress = disciplineStats.progress.toFixed(0);
            
            header.innerHTML = `
                <div class="flex items-start justify-between">
                    
                    <div class="relative w-12 h-12 flex-shrink-0 mt-1 mr-3">
                        <canvas id="${chartCanvasId}"></canvas>
                        <div class="progress-overlay-text absolute inset-0 flex items-center justify-center pointer-events-none">
                            <span class="text-sm font-bold text-indigo-600 dark:text-indigo-400">${progress}%</span>
                        </div>
                    </div>

                    <div class="flex-grow flex flex-col pr-2">
                        <button class="discipline-header-btn text-left focus:outline-none w-full flex items-center justify-between" data-d-id="${d.id}" title="Expandir/Recolher Temas">
                            <h2 class="text-lg font-bold text-slate-900 dark:text-slate-100 break-words pr-2">${d.name}</h2>
                            <svg class="chevron w-5 h-5 flex-shrink-0 text-slate-500 dark:text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                        <div class="flex items-center gap-4 text-xs text-slate-600 dark:text-slate-400 mt-1 flex-wrap">
                            <span>Faltam: <strong>${disciplineStats.questionsLeft}Q</strong></span>
                            <span>Fim do Ciclo: <strong>${cycleEndText}</strong></span>
                        </div>
                    </div>
                </div>

                <div class="flex items-center justify-between mt-3">
                    <div class="flex items-center gap-1.5 text-slate-500 dark:text-slate-400">
                        <button class="edit-discipline-btn p-1.5 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700" data-d-id="${d.id}" title="Editar Mat√©ria">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"></path></svg>
                        </button>
                        <button class="consolidate-notes-btn p-1.5 rounded-full hover:bg-sky-100 dark:hover:bg-sky-900/50" data-d-id="${d.id}" title="Baixar todas as anota√ß√µes (.html)">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-sky-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                            </svg>
                        </button>
                        <button class="delete-discipline-btn p-1.5 rounded-full hover:bg-red-100 dark:hover:bg-red-900/50" data-d-id="${d.id}" title="Excluir Mat√©ria">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-red-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                        </button>
                    </div>

                    <div class="flex items-center gap-2 p-1 border border-slate-200 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-700/50">
                        <span class="text-sm font-medium text-slate-700 dark:text-slate-300">Tempo:</span>
                        <span class="timer-display text-sm font-mono font-semibold text-indigo-700 dark:text-indigo-300" data-d-id="${d.id}">${formatTime(timers[d.id]?.time || 0)}</span>
                        <button class="timer-control p-1 rounded-full hover:bg-slate-200 dark:hover:bg-slate-600" data-d-id="${d.id}" data-action="play_pause" title="Play/Pause">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-slate-600 dark:text-slate-400 play-icon ${timers[d.id]?.isRunning ? 'hidden' : ''}" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" /></svg>
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-slate-600 dark:text-slate-400 pause-icon ${!timers[d.id]?.isRunning ? 'hidden' : ''}" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 00-1 1v4a1 1 0 001 1h4a1 1 0 001-1V8a1 1 0 00-1-1H8z" clip-rule="evenodd" /></svg>
                        </button>
                        <button class="timer-control p-1 rounded-full hover:bg-slate-200 dark:hover:bg-slate-600" data-d-id="${d.id}" data-action="reset" title="Zerar">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-slate-600 dark:text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h5m11 2a9 9 0 11-2-7.87" /></svg>
                        </button>
                    </div>
                </div>
            `;

            const themesContainer = document.createElement('div');
            themesContainer.className = 'accordion-content border-t border-slate-200 dark:border-slate-700/70 p-1';
            themesContainer.dataset.dId = d.id;

            if (openDisciplines.has(String(d.id)) || normalizedSearch) {
                themesContainer.classList.add('open');
                header.querySelector('svg.chevron').classList.add('rotate-180');
            }

            if (d.themes && d.themes.length > 0) {
                d.themes.forEach(th => {
                    if (!th.topics) return; 

                    const themeStats = calculateStats(th.topics);
                    const themeEl = document.createElement('div');
                    themeEl.className = 'bg-slate-50 dark:bg-slate-900/50 rounded-lg my-1.5 overflow-hidden';

                    const themeHeader = document.createElement('div');
                    themeHeader.className = 'w-full p-2.5 text-left flex items-center justify-between hover:bg-slate-100 dark:hover:bg-slate-700 cursor-pointer';
                    themeHeader.dataset.thId = th.id;
                    
                    themeHeader.innerHTML = `
                        <button class="theme-header-btn flex-grow text-left flex items-center justify-between">
                            <div class="flex-grow">
                                <h3 class="font-bold text-sm text-slate-800 dark:text-slate-200">${th.name}</h3>
                                <div class="flex items-center gap-3 text-xs text-slate-500 dark:text-slate-400 mt-0.5">
                                    <span>${themeStats.progress.toFixed(1)}%</span>
                                    <span>${themeStats.questionsDone}/${themeStats.totalQuestions} Q</span>
                                </div>
                            </div>
                            <svg class="chevron w-4 h-4 text-slate-500 dark:text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                        <button class="delete-theme-btn p-1 rounded-full hover:bg-red-100 dark:hover:bg-red-900/50 ml-2" data-d-id="${d.id}" data-th-id="${th.id}" title="Excluir Tema">
                                               <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-red-500" viewBox="0 0 20 20" fill="currentColor">
                                                    <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                            </button>
                    `;
                    
                    const topicsContainer = document.createElement('div');
                    topicsContainer.className = 'accordion-content border-t border-slate-100 dark:border-slate-700/70';
                      if (openThemes.has(String(th.id)) || normalizedSearch) {
                              topicsContainer.classList.add('open');
                              themeHeader.querySelector('svg.chevron').classList.add('rotate-180');
                          }

                    th.topics.forEach(t => {
                        if (!t.name || !t.cycle || !t.progress) return; 
// Se o assunto n√£o tem nota local, busca na biblioteca global pelo nome
                    const noteKey = t.name.trim().toLowerCase();
                    if ((!t.notes || t.notes.trim() === "" || t.notes === "<br>") && notesLibrary[noteKey]) {
                        t.notes = notesLibrary[noteKey];
                    }

                        const isCompleted = (t.progress.done || 0) >= (t.cycle.totalQuestions || 0) && (t.cycle.totalQuestions || 0) > 0;
                        const rowBgClass = isCompleted ? 'bg-green-500/20 dark:bg-green-900/40' : '';

                        const cycleProgress = t.cycle.totalQuestions > 0 ? (t.progress.done / t.cycle.totalQuestions * 100) : 0;
                        const accuracy = t.progress.done > 0 ? (t.progress.correct / t.progress.done * 100) : 0;
                        
                        let accuracyIndicator = '<div class="w-2.5 h-2.5 rounded-full bg-slate-300 dark:bg-slate-500" title="Nenhuma quest√£o resolvida"></div>';
                        if (t.progress.done > 0) {
                            if (accuracy < 50) accuracyIndicator = `<div class="w-2.5 h-2.5 rounded-full bg-red-500" title="Acerto < 50% (${accuracy.toFixed(1)}%)"></div>`;
                            else if (accuracy < 75) accuracyIndicator = `<div class="w-2.5 h-2.5 rounded-full bg-yellow-400" title="Acerto entre 50% e 75% (${accuracy.toFixed(1)}%)"></div>`;
                            else accuracyIndicator = `<div class="w-2.5 h-2.5 rounded-full bg-green-500" title="Acerto > 75% (${accuracy.toFixed(1)}%)"></div>`;
                        }
                        const notesButtonClass = (t.notes && t.notes.trim() !== '' && t.notes.trim() !== '<br>') ? 'bg-amber-300 dark:bg-amber-500/50' : 'bg-slate-200 dark:bg-slate-600';

                        const topicRow = document.createElement('div');
                        topicRow.className = `flex flex-wrap items-center justify-between p-2 text-sm border-b border-slate-100 dark:border-slate-700/70 last:border-b-0 last:rounded-b-lg hover:bg-slate-100 dark:hover:bg-slate-700 ${rowBgClass}`;
                        topicRow.innerHTML = `
                            <div class="flex-grow pr-4 basis-full sm:basis-1/2">
                                <p class="font-semibold flex items-center gap-2">${accuracyIndicator} <span class="truncate">${t.name}</span></p>
                                <div class="flex items-center gap-2 mt-1 ml-4 flex-wrap">
                                    <span class="text-xs font-semibold px-2 py-0.5 rounded-full ${difficultyMap[t.difficulty]}">${t.difficulty}</span>
                                    <span class="text-xs font-bold text-indigo-600 dark:text-indigo-400">${accuracy.toFixed(1)}%</span>
                                    <span class="text-xs text-slate-500 dark:text-slate-400 font-normal">(${t.progress.done}/${t.cycle.totalQuestions} Q)</span>
                                </div>
                            </div>
                            <div class="flex items-center gap-1 pl-3 pt-2 sm:pt-0">
                                <button class="action-btn" data-action="questions" data-d-id="${d.id}" data-th-id="${th.id}" data-t-id="${t.id}" title="Registrar Quest√µes"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M10 3a1 1 0 011 1v1h-2V4a1 1 0 011-1zM8 6h4v1H8V6zM7 9a1 1 0 011-1h4a1 1 0 110 2H8a1 1 0 01-1-1zm3 3a1 1 0 100 2h.01a1 1 0 100-2H10z"/><path fill-rule="evenodd" d="M3 18a2 2 0 01-2-2V4a2 2 0 012-2h14a2 2 0 012 2v12a2 2 0 01-2 2H3zm2-2a1 1 0 011-1h8a1 1 0 110 2H6a1 1 0 01-1-1z" clip-rule="evenodd"/></svg></button>
                                <button class="action-btn" data-action="review" data-d-id="${d.id}" data-th-id="${th.id}" data-t-id="${t.id}" title="Concluir Revis√£o"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/></svg></button>
                                <button class="action-btn ${notesButtonClass}" data-action="notes" data-d-id="${d.id}" data-th-id="${th.id}" data-t-id="${t.id}" title="Anota√ß√µes"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828zM5 12V7a1 1 0 011-1h2.172a2 2 0 001.414-.586l1-1a2 2 0 012.828 0l1 1a2 2 0 001.414.586H17a1 1 0 011 1v5a1 1 0 01-1 1H6a1 1 0 01-1-1z"/></svg></button>
                                <button class="action-btn" data-action="edit" data-d-id="${d.id}" data-th-id="${th.id}" data-t-id="${t.id}" title="Editar Assunto"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"></path></svg></button>
                                ${t.materialLink ? `<a href="${t.materialLink}" target="_blank" rel="noopener noreferrer" class="action-btn" title="Abrir Material"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 00-1.414 1.414 4 4 0 005.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5a2 2 0 11-2.828-2.828l3-3zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 00-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" /></svg></a>` : ''}
                            </div>
                        `;
                        topicRow.querySelectorAll('.action-btn').forEach(btn => btn.classList.add('w-6', 'h-6', 'rounded-full', 'hover:opacity-80', 'transition-opacity', 'flex', 'items-center', 'justify-center', 'bg-slate-200', 'dark:bg-slate-600', 'dark:text-slate-300'));
                        topicsContainer.appendChild(topicRow);
                    });
                    
                    themeEl.appendChild(themeHeader);
                    themeEl.appendChild(topicsContainer);
                    themesContainer.appendChild(themeEl);
                });
            } else {
                    themesContainer.innerHTML = `<p class="p-4 text-center text-slate-500 dark:text-slate-400">Nenhum tema nesta mat√©ria.</p>`;
            }

            disciplineEl.appendChild(header);
            disciplineEl.appendChild(themesContainer);
            DOM.disciplinesContainer.appendChild(disciplineEl);

            // --- Chart Initialization ---
            setTimeout(() => {
                const done = disciplineStats.questionsDone;
                const total = disciplineStats.totalQuestions;
                const left = disciplineStats.questionsLeft;
                
                if (total > 0) {
                    const ctx = document.getElementById(chartCanvasId)?.getContext('2d');
                    if (ctx) {
                        if (window.miniCharts[chartCanvasId]) {
                            window.miniCharts[chartCanvasId].destroy();
                        }

                        const chart = new Chart(ctx, {
                            type: 'doughnut',
                            data: {
                                datasets: [{
                                    data: [done, left],
                                    backgroundColor: ['#4F46E5', '#E5E7EB'],
                                    hoverBackgroundColor: ['#4338CA', '#D1D5DB'],
                                    borderWidth: 0,
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                cutout: '75%',
                                plugins: {
                                    legend: { display: false },
                                    tooltip: { enabled: true }
                                },
                                layout: {
                                    padding: 0
                                }
                            }
                        });
                        window.miniCharts[chartCanvasId] = chart;
                    }
                } else if (document.getElementById(chartCanvasId)) {
                    const ctx = document.getElementById(chartCanvasId).getContext('2d');
                    if (window.miniCharts[chartCanvasId]) {
                        window.miniCharts[chartCanvasId].destroy();
                        delete window.miniCharts[chartCanvasId];
                    }
                    ctx.clearRect(0, 0, 48, 48);
                }
            }, 0); 
        });
    };
    
    DOM.addNewDisciplineBtn.addEventListener('click', async () => {
        const name = prompt("Digite o nome da nova mat√©ria:");
        if (!name || !name.trim()) return;
        const goal = prompt(`Qual a sua meta di√°ria de quest√µes para "${name}"?`, "20");
        const dailyGoal = parseInt(goal, 10);
         if (isNaN(dailyGoal) || dailyGoal <= 0) {
            alert("Meta inv√°lida. Por favor, insira um n√∫mero positivo.");
            return;
         }
        const newDiscipline = { id: String(Date.now()), name: name.trim(), themes: [], studyDays: [], dailyGoal: dailyGoal };
        disciplines.push(newDiscipline);
        await saveData();
        populateDisciplineSelect();
        DOM.disciplineSelect.value = newDiscipline.id; 
        renderStudyDaysCheckboxes(newDiscipline.id);
        renderDisciplines();
    });

    DOM.addTopicForm.addEventListener('submit', async e => {
        e.preventDefault();
        const disciplineId = DOM.disciplineSelect.value;
        const themeName = document.getElementById('theme-name').value.trim();
        if(!disciplineId || !themeName) { alert("Por favor, selecione a mat√©ria e preencha o tema."); return; }
        
        const discipline = disciplines.find(d => String(d.id) === String(disciplineId));
        const selectedDays = [...DOM.studyDaysCheckboxes.querySelectorAll('input:checked')].map(cb => parseInt(cb.value));
        discipline.studyDays = selectedDays;

        let theme = discipline.themes.find(th => th.name.toLowerCase() === themeName.toLowerCase());
        if (!theme) {
            theme = { id: String(Date.now()), name: themeName, topics: [] };
            discipline.themes.push(theme);
        }

        const newTopic = {
            id: String(Date.now() + 1), name: document.getElementById('topic-name').value,
            difficulty: document.getElementById('topic-difficulty').value,
            cycle: { totalQuestions: parseInt(document.getElementById('cycle-total-questions').value, 10) || 0 },
            progress: { done: 0, correct: 0 }, 
            nextReviewDate: null, 
            notes: "", 
            materialLink: document.getElementById('material-link').value,
            firstReviewScheduled: false // NOVO CAMPO para agendamento autom√°tico
        };
        theme.topics.push(newTopic);
        await saveData();
        openDisciplines.add(disciplineId);
        openThemes.add(String(theme.id));
        await renderAll();
        e.target.reset();
        document.getElementById('theme-name').value = themeName;
        DOM.disciplineSelect.value = disciplineId;
        renderStudyDaysCheckboxes(disciplineId);
    });
    
    DOM.disciplineSelect.addEventListener('change', (e) => {
        renderStudyDaysCheckboxes(e.target.value);
    });

    DOM.questionsModal.form.addEventListener('submit', async e => {
        e.preventDefault();
        const doneInput = DOM.questionsModal.done;
        const correctInput = DOM.questionsModal.correct;
        const newDone = parseInt(doneInput.value, 10);
        const newCorrect = parseInt(correctInput.value, 10);
        
        const { dId, thId, tId } = { 
            dId: DOM.questionsModal.disciplineId.value, 
            thId: DOM.questionsModal.themeId.value,
            tId: DOM.questionsModal.topicId.value 
        };
        const topic = getTopic(dId, thId, tId);
        if (!topic) return;

        const maxQuestions = topic.cycle.totalQuestions;
        const oldDone = topic.progress.done || 0;
        const oldCorrect = topic.progress.correct || 0;

        if(newCorrect > newDone) {
            alert('O n√∫mero de acertos n√£o pode ser maior que o n√∫mero de quest√µes resolvidas.');
            return;
        }

        if (isNaN(newDone) || isNaN(newCorrect) || newDone < 0 || newDone > maxQuestions || newCorrect > maxQuestions) { 
            alert(`Valores inv√°lidos. Verifique: 1) Resolvidas/Corretas n√£o excedem o total (${maxQuestions}). 2) Resolvidas/Corretas s√£o n√∫meros positivos.`); 
            return; 
        }

        if (newDone < oldDone) {
            alert(`A nova contagem de quest√µes resolvidas (${newDone}) n√£o pode ser menor que o total anterior (${oldDone}). Se voc√™ precisa corrigir um erro, insira o valor correto do total acumulado.`);
            return;
        }

        const questionsDoneSession = newDone - oldDone;
        // CORRE√á√ÉO: Calcula a diferen√ßa correta de acertos, n√£o apenas o novo total
        const questionsCorrectSession = newCorrect - oldCorrect;

        const todayStr = getToday();
        
        // 1. Remove qualquer registro EXISTENTE do Hist√≥rico para este T√ìPICO e DIA.
        questionHistory = questionHistory.filter(item => !(item.date === todayStr && String(item.topicId) === String(tId)));

        // 2. Se houver novas quest√µes feitas (diferen√ßa > 0), registra APENAS a diferen√ßa.
        if (questionsDoneSession > 0) {
            questionHistory.push({
                date: todayStr,
                disciplineId: String(dId), themeId: String(thId), topicId: String(tId),
                done: questionsDoneSession, 
                correct: questionsCorrectSession 
            });
        }

        // Atualiza o progresso TOTAL do t√≥pico
        topic.progress.done = newDone; 
        topic.progress.correct = newCorrect;

        // ====================================================================
        // NOVO: L√ìGICA DE AGENDAMENTO AUTOM√ÅTICO NA CONCLUS√ÉO
        // ====================================================================
        const isCompleted = newDone >= maxQuestions && maxQuestions > 0;
        const isFirstReview = topic.firstReviewScheduled === false;
        
        if (isCompleted && isFirstReview) {
            const finalAccuracy = (newCorrect / newDone) * 100;
            let daysToSchedule = 0;

            if (finalAccuracy <= 50) {
                daysToSchedule = 1; // 0% a 50%: Pr√≥ximo dia
            } else if (finalAccuracy <= 70) {
                daysToSchedule = 3; // 51% a 70%: 3 dias
            } else { // acima de 71%
                daysToSchedule = 7; // Acima de 71%: 7 dias
            }
            
            // Agenda a primeira revis√£o
            if (daysToSchedule > 0) {
                topic.nextReviewDate = addDays(todayStr, daysToSchedule);
                topic.firstReviewScheduled = true; // Marca como agendado automaticamente
                alert(`‚úÖ Assunto Finalizado! Revis√£o agendada automaticamente para ${daysToSchedule} dia(s) (Acerto: ${finalAccuracy.toFixed(1)}%).`);
            }
        }
        // ====================================================================

        await saveData();
        await renderAll();
        closeModal();
    });

    const scheduleNextReview = async (days) => {
        const topic = getTopic(activeTopicIds.disciplineId, activeTopicIds.themeId, activeTopicIds.topicId);
        if (topic) {
            topic.nextReviewDate = addDays(getToday(), days);
            
            // Garantir que a flag seja true se o agendamento ocorrer
            topic.firstReviewScheduled = true;
            
            await saveData();
            
            // CORRE√á√ÉO DE BUG: Garante que, se estiver em uma sess√£o de revis√£o, o modal
            // de agendamento seja fechado e a sess√£o avance para o pr√≥ximo item.
            if (reviewSessionState.active) {
                closeModal(); // Fecha o modal de agendamento de revis√£o
                handleNextReviewInSession(true); // Avan√ßa para o pr√≥ximo t√≥pico da sess√£o
            } else {
                closeModal(); // Fecha o modal de agendamento de revis√£o (veio do cart√£o)
            }
            await renderAll();
        }
    };

    DOM.reviewModal.options.addEventListener('click', e => {
        if (e.target.classList.contains('review-schedule-btn')) {
            scheduleNextReview(parseInt(e.target.dataset.days, 10));
        }
    });

    DOM.reviewModal.customDate.addEventListener('change', () => {
        const selectedDateStr = DOM.reviewModal.customDate.value;
        const selectedDate = getLocalDateObject(selectedDateStr);

        if (!selectedDate) return;
        
        const todayDate = getLocalDateObject(getToday());
        const diffTime = selectedDate.getTime() - todayDate.getTime();
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        scheduleNextReview(diffDays >= 0 ? diffDays : 0);
    });
    
    // CORRE√á√ÉO DE BUG: Ajusta a l√≥gica de salvamento para que, se estiver na
    // sess√£o de revis√£o, ela apenas feche o modal de anota√ß√µes e retorne √† sess√£o.
    DOM.notesModal.saveBtn.addEventListener('click', async () => {
        const topic = getTopic(activeTopicIds.disciplineId, activeTopicIds.themeId, activeTopicIds.topicId);
        if (topic) { 
            topic.notes = DOM.notesModal.editor.innerHTML; 
            await saveData();
            await renderAll();
            // Apenas fecha o modal de anota√ß√µes, retornando ao modal anterior (sess√£o de revis√£o ou cart√£o).
            closeModal(); 
        }
    });
    
    // -- ALTERA√á√ÉO: MAXIMIZAR MODAL --
    DOM.notesModal.toggleMaximizeBtn.addEventListener('click', () => {
        const modal = DOM.notesModal.modal;
        const isMaximized = modal.classList.toggle('maximized');

        modal.querySelector('.maximize-icon').classList.toggle('hidden', isMaximized);
        modal.querySelector('.restore-icon').classList.toggle('hidden', !isMaximized);
        
        // Recalcula o tamanho da √°rea de edi√ß√£o para preencher a tela no modo maximizado
        const editor = DOM.notesModal.editor;
        if(isMaximized) {
            // Calcula a altura da viewport menos a altura combinada do cabe√ßalho fixo e do rodap√©
            const headerHeight = DOM.notesModal.modal.querySelector('#notes-modal-header').offsetHeight;
            const toolbarHeight = DOM.notesModal.modal.querySelector('#notes-toolbar').offsetHeight;
            const footerHeight = DOM.notesModal.modal.querySelector('.modal-content-area > .flex.justify-end').offsetHeight;
            
            // 170px √© um valor de seguran√ßa que cobre padding, margens, etc.
            const totalFixedHeight = headerHeight + toolbarHeight + footerHeight + 40; 
            editor.style.height = `calc(100vh - ${totalFixedHeight}px)`;
            editor.style.minHeight = '100px';
        } else {
             editor.style.height = 'auto'; // Volta para altura din√¢mica ou CSS padr√£o
             editor.style.minHeight = '20rem';
        }

    });
    // ----------------------------------

    document.getElementById('notes-toolbar').addEventListener('click', (e) => {
        const btn = e.target.closest('button[data-command="removeFormat"]');
        if (btn) {
            e.preventDefault();
            document.execCommand('removeFormat', false, null);
            document.execCommand('undo');
            DOM.notesModal.editor.focus();
        }
    });

    function parseEditalToStructuredData(text) {
    const lines = text.split(/\r?\n/);
    const materias = [];
    let currentMateria = null;
    let currentTema = null;

    lines.forEach(line => {
        line = line.trim();
        if (!line) return;

        const isMateriaCandidate = !/^\d/.test(line) && line.length > 5;
        const totalAlpha = (line.match(/[a-zA-Z√Ä-√ø]/g) || []).length;
        const totalUpper = (line.match(/[A-Z√Ä-≈∏]/g) || []).length;

        if (isMateriaCandidate && totalAlpha > 0 && (totalUpper / totalAlpha) > 0.8) {
            currentMateria = { name: line.replace(':', '').trim(), themes: [] };
            materias.push(currentMateria);
            currentTema = null; 
            return;
        }

        if (!currentMateria) {
            return; 
        }

        const match = line.match(/^(\d+(?:\.\d+)*)\s*[.-]?\s*(.*)/);

        if (match) {
            const number = match[1];
            const name = match[2].trim();
            const fullName = `${number} ${name}`;
            const parts = number.split('.');
            const level = parts.length;

            if (!name) return;

            if (level === 1) {
                currentTema = { name: fullName, assuntos: [] };
                currentMateria.themes.push(currentTema);
            }
            else if (currentTema) {
                currentTema.assuntos.push({ name: fullName });
            }
        }
    });

    materias.forEach(materia => {
        materia.themes.forEach(tema => {
            if (tema.assuntos.length === 0 && tema.name) {
                tema.assuntos.push({ name: tema.name });
            }
        });
        materia.themes = materia.themes.filter(tema => tema.assuntos.length > 0);
    });

    return materias;
}


    function renderEditalPreview(data) {
        const container = DOM.editalPreviewContent;
        container.innerHTML = '';
        if (!data || data.length === 0) {
            container.innerHTML = '<p class="text-red-500">Nenhuma estrutura v√°lida foi encontrada no arquivo.</p>';
            return;
        }

        data.forEach((materia, materiaIndex) => {
            const materiaEl = document.createElement('div');
            materiaEl.className = 'p-3 bg-white dark:bg-slate-700 rounded-lg shadow-sm';
            
            let html = `<h3 class="text-lg font-bold text-indigo-700 dark:text-indigo-400" contenteditable="true" data-type="materia" data-materia-index="${materiaIndex}">${materia.name}</h3>`;
            
            if (materia.themes && materia.themes.length > 0) {
                html += '<ul class="list-disc pl-5 mt-2 space-y-2">';
                materia.themes.forEach((tema, temaIndex) => {
                    if (tema.name) {
                        html += `<li><span class="font-semibold" contenteditable="true" data-type="tema" data-materia-index="${materiaIndex}" data-tema-index="${temaIndex}">${tema.name}</span>`;
                    }
                    
                    if (tema.assuntos && tema.assuntos.length > 0) {
                        html += '<ul class="list-circle pl-5 mt-1 space-y-1 text-sm text-slate-700 dark:text-slate-300">';
                        tema.assuntos.forEach((assunto, assuntoIndex) => {
                            html += `<li>
                                <div class="flex justify-between items-center">
                                    <span contenteditable="true" data-type="assunto" data-materia-index="${materiaIndex}" data-tema-index="${temaIndex}" data-assunto-index="${assuntoIndex}">${assunto.name}</span>
                                    <button class="remove-preview-item text-red-500 hover:text-red-700 font-bold px-2" title="Remover item" data-materia-index="${materiaIndex}" data-tema-index="${temaIndex}" data-assunto-index="${assuntoIndex}">&times;</button>
                                </div>
                            </li>`;
                        });
                        html += '</ul>';
                    }

                    if(tema.name){
                        html += `</li>`;
                    }
                });
                html += '</ul>';
            }
            materiaEl.innerHTML = html;
            container.appendChild(materiaEl);
        });
    }

    DOM.importEditalBtn.addEventListener('click', () => {
        const file = DOM.editalFileInput.files[0];
        if (!file) {
            alert("Por favor, selecione um arquivo de edital (.txt).");
            return;
        }

        const reader = new FileReader();
        reader.onload = (e) => {
            const editalContent = e.target.result;
            tempEditalData = parseEditalToStructuredData(editalContent);
            renderEditalPreview(tempEditalData);
            openModal(DOM.editalPreviewModal);
        };
        reader.readAsText(file);
        DOM.editalFileInput.value = '';
    });
    
    DOM.saveEditalPlanBtn.addEventListener('click', async () => {
        const editableElements = DOM.editalPreviewContent.querySelectorAll('[contenteditable="true"]');
        editableElements.forEach(el => {
            const { type, materiaIndex, temaIndex, assuntoIndex } = el.dataset;
            const newText = el.textContent.trim();
            
            try {
                switch (type) {
                    case 'materia':
                        if (tempEditalData[materiaIndex]) tempEditalData[materiaIndex].name = newText;
                        break;
                    case 'tema':
                       if (tempEditalData[materiaIndex]?.themes[temaIndex]) tempEditalData[materiaIndex].themes[temaIndex].name = newText;
                        break;
                    case 'assunto':
                        if (tempEditalData[materiaIndex]?.themes[temaIndex]?.assuntos[assuntoIndex]) tempEditalData[materiaIndex].themes[temaIndex].assuntos[assuntoIndex].name = newText;
                        break;
                }
            } catch (e) {
                console.error("Erro ao atualizar dados editados do edital:", e, el.dataset);
            }
        });


        if (!tempEditalData) {
            alert('N√£o h√° dados do edital para salvar.');
            return;
        }

        let importedCount = 0;
        tempEditalData.forEach(materiaData => {
            let discipline = disciplines.find(d => d.name.toLowerCase() === materiaData.name.toLowerCase());
            if (!discipline) {
                discipline = {
                    id: String(Date.now() + Math.random()),
                    name: materiaData.name,
                    themes: [],
                    dailyGoal: 20,
                    studyDays: []
                };
                disciplines.push(discipline);
            }

            materiaData.themes.forEach(themeData => {
                let theme = discipline.themes.find(th => th.name.toLowerCase() === themeData.name.toLowerCase());
                if (!theme) {
                    theme = { id: String(Date.now() + Math.random()), name: themeData.name, topics: [] };
                    discipline.themes.push(theme);
                }

                themeData.assuntos.forEach(assuntoData => {
                    const topicExists = theme.topics.some(t => t.name.toLowerCase() === assuntoData.name.toLowerCase());
                    if (!topicExists) {
                        const newTopic = {
                            id: String(Date.now() + Math.random()),
                            name: assuntoData.name,
                            difficulty: 'M√©dia',
                            cycle: { totalQuestions: 0 },
                            progress: { done: 0, correct: 0 },
                            nextReviewDate: null,
                            notes: "",
                            materialLink: "",
                            firstReviewScheduled: false // NOVO CAMPO
                        };
                        theme.topics.push(newTopic);
                        importedCount++;
                    }
                });
            });
        });

        await saveData();
        await renderAll();
        closeModal();
        alert('Planejamento salvo com sucesso! Agora, configure a quantidade de quest√µes, dias de estudo e outros detalhes para cada assunto.');
        tempEditalData = null;
    });
    
    DOM.editTopicModal.form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const { dId, thId, tId } = { 
            dId: DOM.editTopicModal.disciplineId.value, 
            thId: DOM.editTopicModal.themeId.value, 
            tId: DOM.editTopicModal.topicId.value 
        };
        const topic = getTopic(dId, thId, tId);
        if (topic) {
            topic.name = DOM.editTopicModal.name.value;
            topic.difficulty = DOM.editTopicModal.difficulty.value;
            topic.cycle.totalQuestions = parseInt(DOM.editTopicModal.totalQuestions.value, 10);
            topic.materialLink = DOM.editTopicModal.materialLink.value;
            await saveData();
            await renderAll();
            closeModal();
        }
    });

    DOM.editDisciplineModal.form.addEventListener('submit', async e => {
        e.preventDefault();
        const M = DOM.editDisciplineModal;
        const disciplineId = M.id.value;
        const discipline = disciplines.find(d => String(d.id) === String(disciplineId));
        if (discipline) {
            discipline.name = M.name.value.trim();
            discipline.dailyGoal = parseInt(M.goal.value, 10) || 20;
            discipline.studyDays = [...M.days.querySelectorAll('input:checked')].map(cb => parseInt(cb.value));
            await saveData();
            await renderAll();
            closeModal();
        }
    });

    DOM.editDisciplineModal.addContentBtn.addEventListener('click', () => {
        const disciplineId = DOM.editDisciplineModal.id.value;
        closeModal();
        DOM.toggleableContent.classList.remove('hidden');
        DOM.toggleFormBtn.textContent = 'Ocultar Formul√°rio';
        DOM.disciplineSelect.value = disciplineId;
        DOM.disciplineSelect.dispatchEvent(new Event('change'));
        document.getElementById('theme-name').focus();
    });


    DOM.toggleFormBtn.addEventListener('click', () => {
        DOM.toggleableContent.classList.toggle('hidden');
        DOM.toggleFormBtn.textContent = DOM.toggleableContent.classList.contains('hidden') 
            ? '+ Adicionar' 
            : 'Ocultar';
    });

    function consolidateAndDownloadNotes(discipline) {
        // ... (Seu c√≥digo consolidateAndDownloadNotes) ...
        const notesData = (discipline.themes || []).flatMap(theme => ({
            themeName: theme.name,
            topics: (theme.topics || []).filter(t => t.notes && t.notes.trim() !== '' && t.notes.trim() !== '<br>')
                                                       .map(t => ({ topicName: t.name, notes: t.notes }))
        })).filter(theme => theme.topics.length > 0);

        if (notesData.length === 0) {
            alert(`A mat√©ria "${discipline.name}" n√£o possui nenhuma anota√ß√£o salva para download.`);
            return;
        }

        let contentHtml = '';
        notesData.forEach((theme, themeIndex) => {
            contentHtml += `<h2 style="color: #1E40AF; margin-top: 25px; border-bottom: 1px solid #eee; padding-bottom: 3px; font-size: 18px;">Tema: ${theme.themeName}</h2>`;

            theme.topics.forEach(topic => {
                contentHtml += `<h3 style="color: #374151; margin-top: 15px; font-style: italic; font-size: 16px;">Assunto: ${topic.topicName}</h3>`;
                
                let cleanedNotes = topic.notes
                    .replace(/class="selected"/g, '')
                    .replace(/resize: both; overflow: hidden;/g, 'max-width: 100%; height: auto;')
                    .replace(/style="width: 95%;/g, 'style="max-width: 100%;')
                    .replace(/<img/g, '<img style="max-width: 100%; height: auto; display: block; margin: 10px auto;"');
                    
                contentHtml += `<div class="note-content" style="border: 1px solid #ccc; padding: 15px; margin-bottom: 20px; border-radius: 5px; background-color: #f9f9f9;">${cleanedNotes}</div>`;
            });

            if (themeIndex < notesData.length - 1) {
                contentHtml += `<div style="page-break-before: always;"></div>`;
            }
        });

        const htmlContent = `
            <!DOCTYPE html>
            <html>
            <head>
                <meta charset="utf-8">
                <title>Anota√ß√µes ${discipline.name}</title>
            </head>
            <body style="font-family: Arial, sans-serif; background-color: #f0f2f5; padding: 20px;">
                <h1 style="color: #4F46E5; border-bottom: 2px solid #ddd; padding-bottom: 5px; font-size: 24px;">Anota√ß√µes: ${discipline.name}</h1>
                ${contentHtml}
            </body>
            </html>
        `;

        const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
        
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        
        link.download = `Anotacoes_${discipline.name.replace(/ /g, '_')}_${new Date().toISOString().split('T')[0]}.html`;
        
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        alert(`Download das anota√ß√µes da mat√©ria "${discipline.name}" iniciado. Voc√™ recebeu um arquivo .html. Abra e use "Salvar Como" para obter o formato MHT no Word.`);
    }
    function openEditDisciplineModal(dId) {
        const discipline = disciplines.find(d => String(d.id) === String(dId));
        if (!discipline) return;
        
        const M = DOM.editDisciplineModal;
        M.title.textContent = `Gerenciar Mat√©ria`;
        M.id.value = discipline.id;
        M.name.value = discipline.name;
        M.goal.value = discipline.dailyGoal;

        M.days.innerHTML = '';
        weekDays.forEach((day, index) => {
            const label = document.createElement('label');
            label.className = 'flex items-center gap-2 cursor-pointer';
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.value = index;
            checkbox.className = 'h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 dark:bg-slate-600 dark:border-slate-500';
            if (discipline.studyDays.includes(index)) checkbox.checked = true;
            label.appendChild(checkbox);
            label.append(day);
            M.days.appendChild(label);
        });

        openModal(M.modal);
    }

    DOM.reviewsTodayContainer.addEventListener('click', async e => {
        const dismissBtn = e.target.closest('.dismiss-review-btn');
        if (dismissBtn) {
            e.stopPropagation();
            const { dId, thId, tId } = dismissBtn.dataset;
            const topic = getTopic(dId, thId, tId);
            if (topic && confirm(`Tem certeza que deseja dispensar a revis√£o para "${topic.name}"?`)) {
                topic.nextReviewDate = null;
                await saveData();
                renderDashboard();
            }
        }
    });

    DOM.disciplinesContainer.addEventListener('click', e => {
        const headerBtn = e.target.closest('.discipline-header-btn');
        const themeBtn = e.target.closest('.theme-header-btn');
        const editBtn = e.target.closest('.edit-discipline-btn');
        const actionBtn = e.target.closest('.action-btn');
        const consolidateBtn = e.target.closest('.consolidate-notes-btn');
        const toggleAllThemesBtn = e.target.closest('.toggle-all-themes-btn');
        const timerBtn = e.target.closest('.timer-control');
        const deleteDisciplineBtn = e.target.closest('.delete-discipline-btn');
        const deleteThemeBtn = e.target.closest('.delete-theme-btn');

        if (timerBtn || editBtn || deleteDisciplineBtn || actionBtn || consolidateBtn || toggleAllThemesBtn) {
             e.stopPropagation();
        }

        if (timerBtn) {
            const { dId, action } = timerBtn.dataset;
            handleTimerAction(dId, action);
            return;
        }

        if (deleteDisciplineBtn) {
            const { dId } = deleteDisciplineBtn.dataset;
            const discipline = disciplines.find(d => String(d.id) === String(dId));
            if (discipline && confirm(`Tem certeza que deseja excluir a mat√©ria "${discipline.name}" e todos os seus temas e assuntos?`)) {
                disciplines = disciplines.filter(d => String(d.id) !== String(dId));
                openDisciplines.delete(String(dId));
                saveData();
                renderAll(DOM.globalSearch.value);
            }
            return;
        }

        if (deleteThemeBtn) {
            const { dId, thId } = deleteThemeBtn.dataset;
            const discipline = disciplines.find(d => String(d.id) === String(dId));
            if (discipline) {
                const theme = discipline.themes.find(th => String(th.id) === String(thId));
                if (theme && confirm(`Tem certeza que deseja excluir o tema "${theme.name}" e todos os seus assuntos?`)) {
                    discipline.themes = discipline.themes.filter(th => String(th.id) !== String(thId));
                    openThemes.delete(String(thId));
                    saveData();
                    renderDisciplines(DOM.globalSearch.value);
                }
            }
            return;
        }


        if (toggleAllThemesBtn) {
            const { dId } = toggleAllThemesBtn.dataset;
            const discipline = disciplines.find(d => String(d.id) === String(dId));
            if (!discipline || !discipline.themes) return;
            
            const allThemeIds = discipline.themes.map(th => String(th.id));
            const areAllOpen = allThemeIds.every(id => openThemes.has(id));
            
            allThemeIds.forEach(id => {
                if (areAllOpen) { 
                    openThemes.delete(id);
                } else { 
                    openThemes.add(id);
                }
            });
            renderDisciplines(DOM.globalSearch.value);
            return;
        }

        if (consolidateBtn) {
            const { dId } = consolidateBtn.dataset;
            const discipline = disciplines.find(d => String(d.id) === String(dId));
            if (discipline) consolidateAndDownloadNotes(discipline);
            return;
        }

        if (editBtn) {
            const { dId } = editBtn.dataset;
            openEditDisciplineModal(dId);
            return;
        }
        
        if (themeBtn) {
            const themeHeaderDiv = themeBtn.closest('div').closest('div');
            const { thId } = themeHeaderDiv.dataset;
            const content = themeHeaderDiv.nextElementSibling;
            const icon = themeHeaderDiv.querySelector('svg.chevron');
            if (content.classList.toggle('open')) {
                openThemes.add(thId);
            } else {
                openThemes.delete(thId);
            }
            icon.classList.toggle('rotate-180');
            return;
        }


        if (headerBtn) {
            const disciplineEl = headerBtn.closest('.discipline-card'); 
            if (!disciplineEl) return;

            const dId = headerBtn.dataset.dId;
            const content = disciplineEl.querySelector('.accordion-content');
            const icon = disciplineEl.querySelector('svg.chevron');

            if (!content || !icon || !dId) return; 

            const isOpening = !content.classList.contains('open');

            if (isOpening) {
                openDisciplines.add(dId);
                selectedDisciplineId = dId;
            } else {
                openDisciplines.delete(dId);
                if (selectedDisciplineId === dId) {
                    selectedDisciplineId = null;
                }
            }
            content.classList.toggle('open');
            icon.classList.toggle('rotate-180');
            
            highlightStudyDays(selectedDisciplineId);
            return;
        }

        if(actionBtn) {
            const { action, dId, thId, tId } = actionBtn.dataset;
            const topic = getTopic(dId, thId, tId); if (!topic) return;
            activeTopicIds = { disciplineId: dId, themeId: thId, topicId: tId };

            const actions = {
                questions: () => {
                    DOM.questionsModal.title.textContent = `Quest√µes - ${topic.name}`;
                    DOM.questionsModal.disciplineId.value = dId;
                    DOM.questionsModal.themeId.value = thId;
                    DOM.questionsModal.topicId.value = tId;
                    DOM.questionsModal.done.value = topic.progress.done || '';
                    DOM.questionsModal.correct.value = topic.progress.correct || '';
                    openModal(DOM.questionsModal.modal);
                },
                review: () => {
                    DOM.reviewModal.customDate.value = '';
                    openModal(DOM.reviewModal.modal);
                },
                notes: () => {
                    DOM.notesModal.title.querySelector('h2').textContent = `Anota√ß√µes - ${topic.name}`;
                    DOM.notesModal.editor.innerHTML = topic.notes || ""; 
                    // Garante que n√£o esteja maximizado ao abrir
                    DOM.notesModal.modal.classList.remove('maximized');
                    DOM.notesModal.modal.querySelector('.maximize-icon').classList.remove('hidden');
                    DOM.notesModal.modal.querySelector('.restore-icon').classList.add('hidden');
                    openModal(DOM.notesModal.modal);
                },
                edit: () => {
                    const M = DOM.editTopicModal;
                    M.disciplineId.value = dId; M.themeId.value = thId; M.topicId.value = tId;
                    M.name.value = topic.name; M.totalQuestions.value = topic.cycle.totalQuestions;
                    M.materialLink.value = topic.materialLink;
                    M.difficulty.innerHTML = '';
                    difficultyOptions.forEach(opt => {
                        const option = document.createElement('option');
                        option.value = opt; option.textContent = opt;
                        if(topic.difficulty === opt) option.selected = true;
                        M.difficulty.appendChild(option);
                    });
                    openModal(M.modal);
                },
                delete: async () => {
                    if (confirm(`Tem certeza que deseja excluir o assunto "${topic.name}"?`)) {
                        const discipline = disciplines.find(d => String(d.id) === String(dId));
                        const theme = discipline.themes.find(th => String(th.id) === String(thId));
                        theme.topics = theme.topics.filter(t => String(t.id) !== String(tId));
                        await saveData();
                        await renderAll(DOM.globalSearch.value);
                    }
                }
            };
            if (actions[action]) actions[action]();
        }
    });

    const parseStudyDaysString = (daysStr) => {
        if (!daysStr || typeof daysStr !== 'string') return [];
        return daysStr.toLowerCase().split(',')
            .map(day => day.trim().substring(0, 3))
            .filter(day => weekDaysMap.hasOwnProperty(day))
            .map(day => weekDaysMap[day]);
    };

    DOM.downloadTemplateBtn.addEventListener('click', () => {
        const header = ["Mat√©ria", "Tema", "Assunto", "Total Questoes Assunto", "Dificuldade", "Meta Diaria Materia", "Dias de Estudo", "Link Material"];
        const exampleRow = ["Direito Constitucional", "Controle de Constitucionalidade", "Conceitos e Caracter√≠sticas", 150, "M√©dia", 25, "Seg, Qua, Sex", "https://..."];
        const data = [header, exampleRow];
        const ws = XLSX.utils.aoa_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Plano de Estudos");
        XLSX.writeFile(wb, "Modelo_Plano_de_Estudos.xlsx");
    });
    
    DOM.downloadEditalTemplateBtn.addEventListener('click', () => {
        const content = `GOVERNAN√áA E GEST√ÉO DE TIC:
1 Gest√£o e governan√ßa de TI.
1.1 Planejamento estrat√©gico.
1.2 Alinhamento entre estrat√©gias de tecnologia da informa√ß√£o e de neg√≥cio.
1.2.1 Conceitos e t√©cnicas.
2 Ger√™ncia de projetos.
2.1 Conceitos.
2.2 Processos do PMBOK 7¬™ edi√ß√£o.
2.3 Planejamento e controle de m√©tricas de projeto.
3 COBIT (vers√£o 5).
4 Instru√ß√£o Normativa SGD/ME n¬∫ 94/2022.
5 Guia de Governan√ßa de TIC do SISP (version 2.0).

DESENVOLVIMENTO DE SISTEMAS:
1 Modelagem de processos de neg√≥cio.
1.1 Conceitos b√°sicos.
1.2 Identifica√ß√£o e delimita√ß√£o de processos de neg√≥cio.
1.3 T√©cnicas de mapeamento de processos (models AS-IS e TO-BE).
2 Orienta√ß√£o a objetos.
2.1 Conceitos fundamentais, an√°lise, modelagem e padr√µes de projeto.
2.2 An√°lise e projeto orientados a objetos.
2.3 Polimorfismo, heran√ßa, abstra√ß√£o e encapsulamento.`;
        const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = 'modelo_edital.txt';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    });

    DOM.importExcelBtn.addEventListener('click', () => {
        const file = DOM.excelFileInput.files[0];
        if (!file) { 
            alert("Aviso: Por favor, selecione um arquivo de planilha (.xlsx, .xls ou .csv) no campo 'Escolher arquivo'."); 
            return; 
        }
        
        const reader = new FileReader();
        const fileName = file.name.toLowerCase();
        
        const isBinary = fileName.endsWith('.xlsx') || fileName.endsWith('.xls'); 

        reader.onload = async (e) => {
            try {
                const data = e.target.result;
                let workbook;

                if (isBinary) {
                    workbook = XLSX.read(data, {type: 'array'});
                } else {
                    workbook = XLSX.read(data, {type: 'string'}); 
                }
                
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                
                const json = XLSX.utils.sheet_to_json(worksheet, { header: 1, raw: false });
                
                if (json.length < 2) { 
                    alert("A planilha est√° vazia ou n√£o cont√©m dados v√°lidos.");
                    return;
                }

                const normalizeHeader = (h) => String(h || '').trim().toLowerCase();
                const normalizedHeaders = json[0].map(normalizeHeader);

                const getHeaderIndex = (searchName) => {
                    const normalizedSearch = normalizeHeader(searchName);
                    return normalizedHeaders.findIndex(h => h === normalizedSearch);
                };

                const headers = json[0];
                const dataRows = json.slice(1);

                let importedCount = 0;
                let disciplineMap = new Map();
                
                const materiaIndex = getHeaderIndex("mat√©ria");
                const themeIndex = getHeaderIndex("tema");
                const topicNameIndex = getHeaderIndex("assunto");
                const totalQuestionsIndex = getHeaderIndex("total questoes assunto");
                const difficultyIndex = getHeaderIndex("dificuldade");
                const dailyGoalIndex = getHeaderIndex("meta diaria materia");
                const studyDaysIndex = getHeaderIndex("dias de estudo");
                const materialLinkIndex = getHeaderIndex("link material");


                if (materiaIndex === -1 || themeIndex === -1 || topicNameIndex === -1 || totalQuestionsIndex === -1) {
                    alert("Erro: O arquivo n√£o cont√©m todas as colunas obrigat√≥rias ('Mat√©ria', 'Tema', 'Assunto', 'Total Questoes Assunto'). Verifique os cabe√ßalhos do seu arquivo.");
                    return;
                }

                const findOrCreateDiscipline = (name, row) => {
                    const normalizedName = name.trim().toLowerCase();
                    if (disciplineMap.has(normalizedName)) {
                        return disciplineMap.get(normalizedName);
                    }
                    
                    let discipline = disciplines.find(d => d.name.toLowerCase() === normalizedName);
                    if (!discipline) {
                        
                        const dailyGoal = parseInt(row[dailyGoalIndex], 10) || 20;
                        const studyDaysStr = row[studyDaysIndex] || "";

                        discipline = {
                            id: String(Date.now() + Math.random()), 
                            name: name.trim(), 
                            themes: [],
                            dailyGoal: dailyGoal,
                            studyDays: parseStudyDaysString(studyDaysStr),
                        };
                        disciplines.push(discipline);
                    }
                    disciplineMap.set(normalizedName, discipline);
                    return discipline;
                };

                dataRows.forEach((row, index) => {
                    
                    const disciplineName = String(row[materiaIndex] || "").trim().replace(/^"|"$/g, '');
                    const themeName = String(row[themeIndex] || "").trim().replace(/^"|"$/g, '');
                    const topicName = String(row[topicNameIndex] || "").trim().replace(/^"|"$/g, '');

                    if (!disciplineName || !themeName) {
                        return; 
                    }

                    const discipline = findOrCreateDiscipline(disciplineName, row);
                    
                    let theme = discipline.themes.find(th => th.name.toLowerCase() === themeName.toLowerCase());
                    if (!theme) {
                        theme = { id: String(Date.now() + Math.random()), name: themeName, topics: [] };
                        discipline.themes.push(theme);
                    }
                    
                    const finalTopicName = topicName || themeName;
                    const topicExists = theme.topics.some(t => t.name.toLowerCase() === finalTopicName.toLowerCase());

                    if (!topicExists) {
                        const totalQuestions = parseInt(row[totalQuestionsIndex], 10) || 0;
                        const difficulty = String(row[difficultyIndex] || "M√©dia").trim();
                        const materialLink = String(row[materialLinkIndex] || "").trim();
                        
                        const newTopic = {
                            id: String(Date.now() + Math.random()), name: finalTopicName,
                            difficulty: difficultyOptions.includes(difficulty) ? difficulty : "M√©dia",
                            cycle: { totalQuestions: totalQuestions },
                            progress: { done: 0, correct: 0 },
                            nextReviewDate: null,
                            notes: "",
                            materialLink: materialLink,
                            firstReviewScheduled: false // NOVO CAMPO
                        };
                        theme.topics.push(newTopic);
                        importedCount++;
                    }
                });

                if (importedCount > 0) {
                    await saveData();
                    await renderAll();
                    alert(`‚úÖ Sucesso! ${importedCount} novo(s) assunto(s) importado(s) com sucesso!`);
                } else {
                    alert("Nenhum novo assunto para importar. Verifique se as colunas est√£o preenchidas e se os nomes j√° n√£o existem no sistema.");
                }
            } catch (error) {
                console.error("Erro CR√çTICO ao importar planilha:", error);
                alert("Ocorreu um erro CR√çTICO na leitura da planilha. Verifique o formato do arquivo e das colunas. Erro: " + error.message);
            }
        };
        
        if (isBinary) {
            reader.readAsArrayBuffer(file); 
        } else {
            reader.readAsText(file); 
        }

        DOM.excelFileInput.value = '';
    });


function renderCalendar(year, month) {
        const calendarEl = DOM.calendarModal;
        calendarEl.innerHTML = '';

        const reviewsByDate = {};
        disciplines.flatMap(d => 
            (d.themes || []).flatMap(th => 
                (th.topics || []).map(t => ({...t, disciplineId: d.id, themeId: th.id, disciplineName: d.name}))
            )
        ).forEach(t => {
            if (t.nextReviewDate) {
                const dateStr = t.nextReviewDate;
                if (!reviewsByDate[dateStr]) reviewsByDate[dateStr] = [];
                reviewsByDate[dateStr].push(`${t.disciplineName}: ${t.name}`);
            }
        });

        const monthNames = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
        const header = document.createElement('div');
        header.className = 'flex justify-between items-center mb-4';
        header.innerHTML = `
            <button id="prev-month" class="p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700">&lt;</button>
            <h3 class="text-lg font-semibold dark:text-slate-200">${monthNames[month]} ${year}</h3>
            <button id="next-month" class="p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700">&gt;</button>
        `;
        calendarEl.appendChild(header);

        const grid = document.createElement('div');
        grid.className = 'grid grid-cols-7 gap-1 text-center text-sm';
        
        weekDays.forEach(day => {
            grid.innerHTML += `<div class="font-bold text-slate-600 dark:text-slate-400 py-2">${day}</div>`;
        });

        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        for (let i = 0; i < firstDay; i++) {
            grid.innerHTML += '<div></div>';
        }

        for (let day = 1; day <= daysInMonth; day++) {
            const date = new Date(year, month, day);
            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            const hasReview = reviewsByDate[dateStr];
            
            let dayElContent = `<div class="relative p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700 cursor-pointer ${hasReview ? 'font-bold' : ''}">
                ${day}
                ${hasReview ? `<div class="absolute top-1 right-1 w-2 h-2 bg-indigo-500 rounded-full"></div>` : ''}
            </div>`;
            if (hasReview) {
                dayElContent = `<div class="tooltip">${dayElContent}<span class="tooltiptext text-left">${reviewsByDate[dateStr].join('<br>')}</span></div>`;
            }
            grid.innerHTML += dayElContent;
        }
        
        calendarEl.appendChild(grid);
        
        calendarEl.querySelector('#prev-month').onclick = () => renderCalendar(month === 0 ? year - 1 : year, month === 0 ? 11 : month - 1);
        calendarEl.querySelector('#next-month').onclick = () => renderCalendar(month === 11 ? year + 1 : year, month === 11 ? 0 : month + 1);
    }
    
    function showInitialReviews() {
        const today = getToday();
        const allTopics = disciplines.flatMap(d => (d.themes || []).flatMap(th => (th.topics || []).map(t => ({...t, disciplineId: t.disciplineId, themeId: t.themeId, disciplineName: d.name}))));
        const reviews = allTopics.filter(t => t.nextReviewDate && getLocalDateObject(t.nextReviewDate) <= getLocalDateObject(today));

        if (reviews.length > 0) {
            const modal = DOM.initialReviewsModal;
            modal.innerHTML = `
                <h2 class="text-2xl font-bold mb-4 text-amber-600 dark:text-amber-400">Revis√µes para Hoje!</h2>
                <p class="text-slate-600 dark:text-slate-400 mb-6">Voc√™ tem ${reviews.length} assunto(s) para revisar hoje:</p>
                <ul class="text-left space-y-2 max-h-60 overflow-y-auto mb-6">
                    ${reviews.map(t => `<li class="p-2 bg-amber-100 dark:bg-amber-900/50 rounded-md">${t.name} <span class="text-xs text-slate-500 dark:text-slate-400">(${t.disciplineName})</span></li>`).join('')}
                </ul>
                <button class="close-modal-btn bg-indigo-600 text-white font-semibold py-2 px-6 rounded-lg">Entendido!</button>
            `;
            openModal(modal);
        }
    }

    DOM.calendarViewBtn.addEventListener('click', () => {
        const today = new Date();
        renderCalendar(today.getFullYear(), today.getMonth());
        openModal(DOM.calendarModal);
    });

    document.body.addEventListener('click', e => { if (e.target.classList.contains('close-modal-btn') || e.target === DOM.modalBackdrop) closeModal(); });

    const notesToolbar = document.getElementById('notes-toolbar');
    const fontColorPalette = document.getElementById('font-color-palette');
    const highlightColorPalette = document.getElementById('highlight-color-palette');

    const colorPalette = ['#FFFFFF', '#EF4444', '#F97316', '#EAB308', '#22C55E', '#3B82F6', '#8B5CF6', '#EC4899', '#000000', '#6B7280'];

    colorPalette.forEach(color => {
        const fontColorDiv = document.createElement('div');
        fontColorDiv.className = 'w-6 h-6 rounded-full cursor-pointer border-2 border-white hover:border-indigo-500';
        fontColorDiv.style.backgroundColor = color;
        fontColorDiv.addEventListener('mousedown', (e) => {
            e.preventDefault();
            document.execCommand('foreColor', false, color);
        });
        fontColorPalette.appendChild(fontColorDiv);

        const highlightColorDiv = document.createElement('div');
        highlightColorDiv.className = 'w-6 h-6 rounded-full cursor-pointer border-2 border-white hover:border-indigo-500';
        highlightColorDiv.style.backgroundColor = color;
        highlightColorDiv.addEventListener('mousedown', (e) => {
            e.preventDefault();
            document.execCommand('backColor', false, color); 
        });
        highlightColorPalette.appendChild(highlightColorDiv);
    });
    
    notesToolbar.addEventListener('click', (e) => {
        const btn = e.target.closest('button');
        if (!btn) return;
        
        const command = btn.dataset.command;
        if (command) {
            e.preventDefault();
            document.execCommand(command, false, null);
            DOM.notesModal.editor.focus();
        }
    });

    const addImageBtn = document.getElementById('add-image-btn');
    addImageBtn.addEventListener('click', (e) => {
        e.preventDefault();
        const url = prompt('Cole a URL da imagem (ou o Base64 completo):');
        if (url) {
            DOM.notesModal.editor.focus();
            const imgHtml = `<img src="${url}" style="max-width: 100%; height: auto; border-radius: 8px; display: block; margin: 8px auto; resize: both; overflow: hidden;" width="95%">`;
            document.execCommand('insertHTML', false, imgHtml);
        }
    });

    DOM.notesModal.editor.addEventListener('click', e => {
        if (e.target.tagName === 'IMG') {
            DOM.notesModal.editor.querySelectorAll('img.selected').forEach(img => img.classList.remove('selected'));
            e.target.classList.add('selected');
        } else {
             DOM.notesModal.editor.querySelectorAll('img.selected').forEach(img => img.classList.remove('selected'));
        }
    });
    
    document.body.addEventListener('keydown', e => {
        if (activeModal === DOM.notesModal.modal && (e.key === 'Backspace' || e.key === 'Delete')) {
            const selectedImage = DOM.notesModal.editor.querySelector('img.selected');
            if (selectedImage) {
                e.preventDefault();
                selectedImage.remove();
            }
        }
    });
    
    function formatTime(seconds) {
        const h = Math.floor(seconds / 3600).toString().padStart(2, '0');
        const m = Math.floor((seconds % 3600) / 60).toString().padStart(2, '0');
        const s = (seconds % 60).toString().padStart(2, '0');
        return `${h}:${m}:${s}`;
    }

    function updateTimerDisplay(dId) {
        const timerDisplay = document.querySelector(`.timer-display[data-d-id="${dId}"]`);
        if (timerDisplay) {
            timerDisplay.textContent = formatTime(timers[dId].time);
        }
    }

    function startTimerInterval(dId) {
        const timer = timers[dId];
        if (timer.interval === null) {
            timer.interval = setInterval(() => {
                timer.time++;
                updateTimerDisplay(dId);
            }, 1000);
            timer.isRunning = true;
        }
        
        const playPauseBtn = document.querySelector(`.timer-control[data-d-id="${dId}"][data-action="play_pause"]`);
        if (playPauseBtn) {
            playPauseBtn.querySelector('.play-icon').classList.add('hidden');
            playPauseBtn.querySelector('.pause-icon').classList.remove('hidden');
        }
    }

    function stopTimerInterval(dId) {
        const timer = timers[dId];
        if (timer.interval !== null) {
            clearInterval(timer.interval);
            timer.interval = null;
            timer.isRunning = false;
        }
        
        const playPauseBtn = document.querySelector(`.timer-control[data-d-id="${dId}"][data-action="play_pause"]`);
        if (playPauseBtn) {
            playPauseBtn.querySelector('.play-icon').classList.remove('hidden');
            playPauseBtn.querySelector('.pause-icon').classList.add('hidden');
        }
    }

    function handleTimerAction(dId, action) {
        if (!timers[dId]) {
            timers[dId] = { time: 0, interval: null, isRunning: false };
        }
        const timer = timers[dId];

        if (action === 'play_pause') {
            if (timer.isRunning) {
                stopTimerInterval(dId);
                saveData();
            } else {
                startTimerInterval(dId);
            }
        } else if (action === 'reset') {
            stopTimerInterval(dId);
            timer.time = 0;
            timer.isRunning = false;
            saveData();
            updateTimerDisplay(dId);
        }
    }

    const renderCycleStudyDaysCheckboxes = () => {
        DOM.cycleCalculator.studyDaysCheckboxes.innerHTML = '';
        weekDays.forEach((day, index) => {
            const label = document.createElement('label');
            label.className = 'flex items-center gap-2 cursor-pointer';
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.value = index;
            if (index >= 1 && index <= 5) checkbox.checked = true;
            checkbox.className = 'h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 dark:bg-slate-600 dark:border-slate-500';
            label.appendChild(checkbox);
            label.append(day);
            DOM.cycleCalculator.studyDaysCheckboxes.appendChild(label);
        });
    };

    const preDefinedSubjects = [
        "Administra√ß√£o Financeira e Or√ßament√°ria (AFO)", "Administra√ß√£o Geral", "Administra√ß√£o Geral e P√∫blica", "Administra√ß√£o P√∫blica", "Auditoria Fiscal", "Auditoria P√∫blica", "Contabilidade de Custos", "Contabilidade Geral", "Contabilidade Geral e de Custos", "Contabilidade P√∫blica", "Direito Administrativo", "Direito Civil", "Direito Civil, Penal e Empresarial", "Direito Constitucional", "Direito Empresarial/Comercial", "Direito Penal", "Direito Tribut√°rio", "Direito Tribut√°rio II ‚Äì Reforma Tribut√°ria", "Economia", "Estat√≠stica", "Legisla√ß√£o Tribut√°ria Estadual", "L√≠ngua Portuguesa", "Matem√°tica Financeira", "Racioc√≠nio L√≥gico", "Racioc√≠nio L√≥gico e Matem√°tica Financeira", "Tecnologia da Informa√ß√£o"
    ].sort();

    const datalist = document.createElement('datalist');
    datalist.id = 'subjects-list';
    preDefinedSubjects.forEach(subject => {
        const option = document.createElement('option');
        option.value = subject;
        datalist.appendChild(option);
    });
    DOM.cycleCalculator.modal.appendChild(datalist);

    DOM.cycleCalculator.btn.addEventListener('click', () => {
        populateCycleCalculator();
        renderCycleStudyDaysCheckboxes();
        openModal(DOM.cycleCalculator.modal);
    });

    function populateCycleCalculator() {
        const list = DOM.cycleCalculator.list;
        list.innerHTML = '';

        if (disciplines.length > 0) {
            disciplines.forEach(d => {
                addCycleDisciplineRow(d);
            });
        } else {
            addCycleDisciplineRow();
            addCycleDisciplineRow();
            addCycleDisciplineRow();
        }
    }

    function addCycleDisciplineRow(discipline = null) {
        const row = document.createElement('div');
        row.className = 'grid grid-cols-12 gap-2 items-center';
        
        const nameValue = discipline ? discipline.name : '';
        const freqValue = (discipline && discipline.studyDays && discipline.studyDays.length > 0) ? discipline.studyDays.length : 2;

        row.innerHTML = `
            <div class="col-span-6 flex items-center gap-2">
                <input type="text" list="subjects-list" placeholder="Nome da Mat√©ria" class="cycle-discipline-name w-full p-2 border border-slate-300 rounded-lg text-sm dark:bg-slate-700 dark:border-slate-600 dark:text-white" value="${nameValue}">
                <button type="button" class="open-subject-questions-btn text-slate-500 hover:text-indigo-600 dark:text-slate-400 dark:hover:text-indigo-400 p-1" title="Detalhar assuntos da mat√©ria">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M10 12a2 2 0 100-4 2 2 0 000 4z" />
                        <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
            <input type="number" placeholder="Peso" value="1" min="1" class="cycle-discipline-weight col-span-2 p-2 border border-slate-300 rounded-lg text-sm text-center dark:bg-slate-700 dark:border-slate-600 dark:text-white">
            <input type="number" placeholder="x/Sem" value="${freqValue}" min="1" class="cycle-discipline-freq col-span-2 p-2 border border-slate-300 rounded-lg text-sm text-center dark:bg-slate-700 dark:border-slate-600 dark:text-white" title="Vezes por semana">
            <div class="col-span-2 flex items-center">
                <select class="cycle-discipline-difficulty w-full p-2 border border-slate-300 rounded-lg text-sm dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                    <option value="0.8">F√°cil</option>
                    <option value="1.0" selected>M√©dia</option>
                    <option value="1.2">Dif√≠cil</option>
                </select>
                <button class="remove-cycle-discipline-btn text-red-500 hover:text-red-700 font-bold text-xl ml-1">&times;</button>
            </div>
        `;
        DOM.cycleCalculator.list.appendChild(row);
    }
    
    DOM.cycleCalculator.addBtn.addEventListener('click', () => addCycleDisciplineRow());
    
    DOM.cycleCalculator.clearBtn.addEventListener('click', () => {
        DOM.cycleCalculator.list.innerHTML = '';
        addCycleDisciplineRow();
        addCycleDisciplineRow();
        addCycleDisciplineRow();
        DOM.cycleCalculator.resultsTable.innerHTML = '<p class="text-slate-500 dark:text-slate-400">Preencha os dados e clique em "Calcular" para ver a distribui√ß√£o.</p>';
        DOM.cycleCalculator.scheduleContainer.classList.add('hidden');
        DOM.cycleCalculator.totalDistributed.textContent = '';
        lastCycleResults = null;
        lastCycleSchedule = null;
    });

    DOM.cycleCalculator.saveBtn.addEventListener('click', async () => {
        if (!lastCycleResults || !lastCycleSchedule || lastCycleResults.length === 0) {
            alert('Por favor, calcule um ciclo antes de salvar.');
            return;
        }

        if (confirm('Deseja aplicar este ciclo ao seu painel? As metas de quest√µes e os dias de estudo das mat√©rias ser√£o atualizados. Mat√©rias n√£o existentes ser√£o criadas.')) {
            
            for (const disciplineName in lastCycleSchedule) {
                const weeklyQuestions = lastCycleSchedule[disciplineName];
                const newStudyDays = [];
                weeklyQuestions.forEach((questions, dayIndex) => {
                    if (questions > 0) {
                        newStudyDays.push(dayIndex);
                    }
                });

                let discipline = disciplines.find(d => d.name.toLowerCase() === disciplineName.toLowerCase());
                const resultData = lastCycleResults.find(r => r.name === disciplineName);

                if (!resultData) {
                    console.warn(`Dados de resultado n√£o encontrados para ${disciplineName}. Pulando.`);
                    continue;
                };

                if (!discipline) {
                    discipline = { 
                        id: String(Date.now() + Math.random()), 
                        name: disciplineName, 
                        themes: [], 
                        studyDays: newStudyDays, 
                        dailyGoal: resultData.questionsPerSession 
                    };
                    disciplines.push(discipline);
                } else {
                    discipline.dailyGoal = resultData.questionsPerSession;
                    discipline.studyDays = newStudyDays;
                }
            }

            await saveData();
            await renderAll();
            closeModal();
            alert('Ciclo aplicado com sucesso! As metas e dias de estudo das mat√©rias foram atualizadas.');
        }
    });

    DOM.cycleCalculator.calculateBtn.addEventListener('click', () => {
        const duration = parseInt(DOM.cycleCalculator.duration.value) || 0;
        const qpd = parseInt(DOM.cycleCalculator.questionsPerDay.value) || 0;
        if (duration <= 0 || qpd <= 0) {
            alert('Preencha a dura√ß√£o e a quantidade de quest√µes por dia.');
            return;
        }

        const selectedCycleDays = [...document.querySelectorAll('#cycle-study-days-checkboxes input:checked')].map(cb => parseInt(cb.value));
        if (selectedCycleDays.length === 0) {
            alert('Selecione pelo menos um dia de estudo para o ciclo.');
            return;
        }
        
        const studyDaysPerWeek = selectedCycleDays.length;
        const totalStudyWeeks = duration * 4;
        const totalQuestionsInCycle = qpd * studyDaysPerWeek * totalStudyWeeks;
        
        const disciplinesData = [];
        let totalAdjustedWeight = 0;
        DOM.cycleCalculator.list.querySelectorAll('.grid').forEach(row => {
            const name = row.querySelector('.cycle-discipline-name').value.trim();
            const weight = parseInt(row.querySelector('.cycle-discipline-weight').value) || 0;
            const freq = parseInt(row.querySelector('.cycle-discipline-freq').value) || 0;
            const difficulty = parseFloat(row.querySelector('.cycle-discipline-difficulty').value);

            if (name && weight > 0 && freq > 0) {
                const adjustedWeight = weight * difficulty * freq;
                disciplinesData.push({ name, weight, freq, difficulty, adjustedWeight });
                totalAdjustedWeight += adjustedWeight;
            }
        });

        if (totalAdjustedWeight <= 0) {
            alert('Adicione mat√©rias com pesos, frequ√™ncias e dificuldades v√°lidos.');
            return;
        }

        const resultsContainer = DOM.cycleCalculator.resultsTable;
        resultsContainer.innerHTML = '';
        
        let results = disciplinesData.map(d => {
            const questions = Math.round((d.adjustedWeight / totalAdjustedWeight) * totalQuestionsInCycle);
            return { ...d, questions };
        });

        let currentTotal = results.reduce((sum, d) => sum + d.questions, 0);
        let diff = totalQuestionsInCycle - currentTotal;
        if (diff !== 0 && results.length > 0) {
            results.sort((a, b) => (b.adjustedWeight / b.freq) - (a.adjustedWeight / a.freq));
            for(let i = 0; i < Math.abs(diff); i++){
                results[i % results.length].questions += Math.sign(diff);
            }
        }

        results.forEach(res => {
            const totalSessionsInCycle = totalStudyWeeks * res.freq;
            res.questionsPerSession = totalSessionsInCycle > 0 ? Math.round(res.questions / totalSessionsInCycle) : 0;
        });

        lastCycleResults = results;

        let weeklySessions = [];
        results.forEach(res => {
            for (let i = 0; i < res.freq; i++) {
                weeklySessions.push({ name: res.name, questions: res.questionsPerSession, originalIndex: disciplinesData.findIndex(d => d.name === res.name) });
            }
        });
        
        let schedule = {};
        let dailyLoad = Object.fromEntries(selectedCycleDays.map(day => [day, 0]));

        weeklySessions.sort((a, b) => b.questions - a.questions);

        for (const session of weeklySessions) {
            let bestDay = -1;
            let minLoad = Infinity;
            
            const availableDays = selectedCycleDays.filter(day => {
                const scheduledSubjects = Object.keys(schedule).filter(subj => schedule[subj] && schedule[subj][day] > 0);
                return !scheduledSubjects.includes(session.name);
            });

            if (availableDays.length > 0) { 
                availableDays.forEach(day => {
                    if (dailyLoad[day] < minLoad) {
                        minLoad = dailyLoad[day];
                        bestDay = day;
                    }
                });
            } else {
                 selectedCycleDays.forEach(day => {
                    if (dailyLoad[day] < minLoad) {
                        minLoad = dailyLoad[day];
                        bestDay = day;
                    }
                 });
            }

            if (bestDay !== -1) {
                if (!schedule[session.name]) schedule[session.name] = [0,0,0,0,0,0,0];
                schedule[session.name][bestDay] += session.questions;
                dailyLoad[bestDay] += session.questions;
            }
        }
        
        lastCycleSchedule = schedule;

        let totalQuestionsDistributed = 0;
        let resultsHtml = `<table class="min-w-full divide-y divide-slate-300 dark:divide-slate-700 text-sm">
                                <thead>
                                    <tr>
                                        <th class="p-2 text-left">Mat√©ria</th>
                                        <th class="p-2 text-right">Qtd. Total (Ciclo)</th>
                                        <th class="p-2 text-center">x/Semana</th>
                                        <th class="p-2 text-right">Qtd. por Sess√£o</th>
                                    </tr>
                                </thead>
                                <tbody>`;
        results.forEach(res => {
            resultsHtml += `<tr class="border-b dark:border-slate-700 hover:bg-slate-100 dark:hover:bg-slate-700/70">
                                <td class="p-2 font-medium">${res.name}</td>
                                <td class="p-2 text-right font-bold text-indigo-600 dark:text-indigo-400">${res.questions}</td>
                                <td class="p-2 text-center">${res.freq}</td>
                                <td class="p-2 text-right">${res.questionsPerSession} Q</td>
                            </tr>`;
            totalQuestionsDistributed += res.questions;
        });
        resultsHtml += `</tbody></table>`;
        resultsContainer.innerHTML = resultsHtml;
        DOM.cycleCalculator.totalDistributed.textContent = `Total Distribu√≠do: ${totalQuestionsDistributed} / ${totalQuestionsInCycle} Q`;
        

        let scheduleHtml = `<table class="w-full text-sm text-left">
                                <thead><tr>
                                    <th class="p-2">Mat√©ria</th>
                                    ${weekDays.map(d => `<th class="p-2 text-center">${d}</th>`).join('')}
                                    <th class="p-2 text-right font-bold">TOTAL SEMANA</th>
                                </tr></thead>
                                <tbody>`;

        const disciplineNames = Object.keys(schedule).sort();

        disciplineNames.forEach(disciplineName => {
            const weeklyQuestions = schedule[disciplineName];
            const totalWeekly = weeklyQuestions.reduce((a, b) => a + b, 0);
            scheduleHtml += `<tr class="border-b dark:border-slate-700">
                                    <td class="p-2 font-medium">${disciplineName}</td>
                                    ${weeklyQuestions.map(q => `<td class="p-2 text-center">${q > 0 ? q : ''}</td>`).join('')}
                                    <td class="p-2 text-right font-bold">${totalWeekly}</td>
                                </tr>`;
        });
        
        let totalRow = [0,0,0,0,0,0,0];
        disciplineNames.forEach(name => {
            schedule[name].forEach((q, i) => {
                totalRow[i] += q;
            });
        });
        
        const weeklyTotalSum = totalRow.reduce((a,b) => a+b, 0);

        scheduleHtml += `</tbody>
                                <tfoot class="font-bold bg-slate-100 dark:bg-slate-700">
                                    <tr>
                                        <td class="p-2">TOTAL</td>
                                        ${totalRow.map(q => `<td class="p-2 text-center">${q} Q</td>`).join('')}
                                        <td class="p-2 text-right">${weeklyTotalSum}</td>
                                    </tr>
                                </tfoot>`;

        scheduleHtml += `</table>`;
        DOM.cycleCalculator.schedule.innerHTML = scheduleHtml;
        DOM.cycleCalculator.scheduleContainer.classList.remove('hidden');
    });

    function initStatsModal() {
        const { filterDiscipline, filterTheme, filterTopic, modal } = DOM.stats;

        DOM.stats.btn.addEventListener('click', () => {
            filterDiscipline.innerHTML = '<option value="">Todas</option>';
            disciplines.forEach(d => {
                filterDiscipline.innerHTML += `<option value="${d.id}">${d.name}</option>`;
            });
            filterTheme.innerHTML = '<option value="">Todos</option>';
            filterTopic.innerHTML = '<option value="">Todos</option>';
            DOM.stats.filterStartDate.value = '';
            DOM.stats.filterEndDate.value = '';
            renderStatsCharts();
            openModal(modal);
        });
        
        filterDiscipline.addEventListener('change', (e) => {
            const dId = e.target.value;
            const currentThemeVal = filterTheme.value;
            filterTheme.innerHTML = '<option value="">Todos</option>';
            if (dId) {
                const discipline = disciplines.find(d => String(d.id) === String(dId));
                if(discipline) {
                    (discipline.themes || []).forEach(th => {
                        const selected = String(th.id) === String(currentThemeVal) ? 'selected' : '';
                        filterTheme.innerHTML += `<option value="${th.id}" ${selected}>${th.name}</option>`;
                    });
                }
            }
            filterTheme.dispatchEvent(new Event('change'));
        });
        
        filterTheme.addEventListener('change', (e) => {
            const thId = e.target.value;
            const dId = filterDiscipline.value;
            filterTopic.innerHTML = '<option value="">Todos</option>';
            if (dId && thId) {
                const discipline = disciplines.find(d => String(d.id) === String(dId));
                const theme = discipline?.themes.find(th => String(th.id) === String(thId));
                if (theme) {
                    (theme.topics || []).forEach(t => {
                        filterTopic.innerHTML += `<option value="${t.id}">${t.name}</option>`;
                    });
                }
            }
        });
        
        DOM.stats.applyFiltersBtn.addEventListener('click', renderStatsCharts);
    }

    function renderStatsCharts() {
        const { filterDiscipline, filterTheme, filterTopic, filterStartDate, filterEndDate } = DOM.stats;
        const dId = filterDiscipline.value;
        const thId = filterTheme.value;
        const tId = filterTopic.value;
        const startDate = filterStartDate.value ? getLocalDateObject(filterStartDate.value) : null;
        const endDate = filterEndDate.value ? getLocalDateObject(filterEndDate.value) : null;

        let filteredHistory = questionHistory.filter(item => {
            const itemDate = getLocalDateObject(item.date);
            if (startDate && itemDate < startDate) return false;
            if (endDate && itemDate > endDate) return false;
            if (dId && String(item.disciplineId) !== String(dId)) return false;
            if (thId && String(item.themeId) !== String(thId)) return false;
            if (tId && String(item.topicId) !== String(tId)) return false;
            return true;
        });

        let totalCorrect = 0;
        let totalDone = 0;
        filteredHistory.forEach(item => {
            totalDone += item.done;
            totalCorrect += item.correct;
        });
        const totalIncorrect = totalDone - totalCorrect;

        const pieLabels = ['Acertos', 'Erros'];
        const pieValues = [totalCorrect, totalIncorrect];
        const pieColors = ['#3B82F6', '#EF4444'];
        
        const chartColors = getChartColors();

        if(statsPieChart) statsPieChart.destroy();
        statsPieChart = new Chart(DOM.stats.pieChartCanvas.getContext('2d'), {
            type: 'pie',
            data: { labels: pieLabels, datasets: [{ data: pieValues, backgroundColor: pieColors }] },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { labels: { color: chartColors.textColor } },
                    tooltip: {
                        callbacks: {
                            label: (context) => {
                                let label = context.label || '';
                                if (label) label += ': ';
                                if (context.parsed !== null && totalDone > 0) {
                                    const percentage = (context.parsed / totalDone * 100).toFixed(1);
                                    label += `${context.raw} (${percentage}%)`;
                                } else { label += context.raw; }
                                return label;
                            }
                        }
                    }
                }
            }
        });
        
        const lineDataByDate = {};
        filteredHistory.forEach(item => {
            lineDataByDate[item.date] = (lineDataByDate[item.date] || 0) + item.done;
        });
        const sortedDates = Object.keys(lineDataByDate).sort((a,b) => getLocalDateObject(a) - getLocalDateObject(b));
        const lineLabels = sortedDates.map(date => getLocalDateObject(date).toLocaleDateString('pt-BR'));
        const lineValues = sortedDates.map(date => lineDataByDate[date]);
        
        if(statsLineChart) statsLineChart.destroy();
        statsLineChart = new Chart(DOM.stats.lineChartCanvas.getContext('2d'), {
            type: 'line',
            data: { labels: lineLabels, datasets: [{ label: 'Quest√µes Feitas', data: lineValues, tension: 0.1, fill: true, backgroundColor: 'rgba(59, 130, 246, 0.2)', borderColor: 'rgba(59, 130, 246, 1)' }] },
            options: { 
                responsive: true, maintainAspectRatio: false,
                scales: { x: { ticks: { color: chartColors.textColor }, grid: { color: chartColors.gridColor } }, y: { beginAtZero: true, ticks: { color: chartColors.textColor }, grid: { color: chartColors.gridColor } } },
                plugins: { legend: { labels: { color: chartColors.textColor } } }
            }
        });
    }

    function openSubjectQuestionsModal(disciplineName) {
        const discipline = disciplines.find(d => d.name.toLowerCase() === disciplineName.toLowerCase());
        
        if (!discipline || !discipline.themes || discipline.themes.length === 0) {
            alert(`A mat√©ria "${disciplineName}" n√£o foi encontrada no seu planejamento ou n√£o possui temas/assuntos cadastrados.`);
            return;
        }

        const M = DOM.subjectQuestionsModal;
        const resultData = lastCycleResults ? lastCycleResults.find(r => r.name === disciplineName) : null;
        const totalCalculated = resultData ? resultData.questions : 0;
        
        M.title.textContent = `Distribuir Quest√µes para: ${discipline.name} (Total Calculado: ${totalCalculated} Q)`;
        M.content.innerHTML = '';
        M.modal.dataset.disciplineId = discipline.id;
        M.modal.dataset.totalCalculated = totalCalculated;

        discipline.themes.forEach(theme => {
            const themeEl = document.createElement('div');
            themeEl.className = 'bg-slate-50 dark:bg-slate-700/50 rounded-lg';

            const themeHeader = document.createElement('div');
            themeHeader.className = 'w-full p-3 text-left flex items-center justify-between cursor-pointer';
            
            themeHeader.innerHTML = `
                <div class="flex-grow">
                    <h3 class="font-bold text-slate-800 dark:text-slate-200">${theme.name}</h3>
                </div>
                <svg class="chevron w-5 h-5 text-slate-500 dark:text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            `;
            
            const topicsContainer = document.createElement('div');
            topicsContainer.className = 'accordion-content border-t border-slate-200 dark:border-slate-700 p-2 space-y-2';

            if (theme.topics.length > 0) {
                theme.topics.forEach(topic => {
                    const topicRow = document.createElement('div');
                    topicRow.className = 'flex items-center justify-between p-2 bg-white dark:bg-slate-700 rounded-md';
                    topicRow.innerHTML = `
                        <label for="topic-q-${topic.id}" class="text-sm text-slate-700 dark:text-slate-300 flex-grow">${topic.name}</label>
                        <input type="number" id="topic-q-${topic.id}"
                            class="w-24 p-1 border border-slate-300 rounded-lg text-center dark:bg-slate-600 dark:border-slate-500"
                            value="${topic.cycle.totalQuestions || ''}"
                            placeholder="Qtd."
                            data-d-id="${discipline.id}"
                            data-th-id="${theme.id}"
                            data-t-id="${topic.id}">
                        `;
                    topicsContainer.appendChild(topicRow);
                });
            } else {
                topicsContainer.innerHTML = '<p class="text-sm text-slate-500 dark:text-slate-400 p-2">Nenhum assunto neste tema.</p>';
            }

            themeHeader.addEventListener('click', () => {
                topicsContainer.classList.toggle('open');
                themeHeader.querySelector('.chevron').classList.toggle('rotate-180');
            });

            themeEl.appendChild(themeHeader);
            themeEl.appendChild(topicsContainer);
            M.content.appendChild(themeEl);
        });
        
        openModal(M.modal);
    }

    DOM.globalSearch.addEventListener('input', (e) => {
        const searchTerm = e.target.value;
        renderDisciplines(searchTerm);
    });

    DOM.criticalSubjectsBtn.addEventListener('click', () => {
        if(DOM.criticalAnalysisControls) {
            const disciplineRadio = DOM.criticalAnalysisControls.querySelector('input[value="discipline"]');
            if(disciplineRadio) disciplineRadio.checked = true;
        }
        renderCriticalAnalysis('discipline');
        openModal(DOM.criticalSubjectsModal);
    });
    
    if(DOM.criticalAnalysisControls) { 
        DOM.criticalAnalysisControls.addEventListener('change', (e) => {
            if (e.target.name === 'analysis-level') {
                renderCriticalAnalysis(e.target.value);
            }
        });
    }

    function renderCriticalAnalysis(level = 'discipline') {
        let analysisList = [];

        if (level === 'discipline') {
            analysisList = disciplines.map(d => {
                const allTopics = (d.themes || []).flatMap(th => th.topics || []);
                const totalDone = allTopics.reduce((sum, t) => sum + (t?.progress?.done || 0), 0);
                const totalCorrect = allTopics.reduce((sum, t) => sum + (t?.progress?.correct || 0), 0);
                const accuracy = totalDone > 0 ? (totalCorrect / totalDone) * 100 : -1;
                return { name: d.name, accuracy, totalDone };
            });
        } else if (level === 'theme') {
            disciplines.forEach(d => {
                (d.themes || []).forEach(th => {
                    const totalDone = (th.topics || []).reduce((sum, t) => sum + (t?.progress?.done || 0), 0);
                    const totalCorrect = (th.topics || []).reduce((sum, t) => sum + (t?.progress?.correct || 0), 0);
                    const accuracy = totalDone > 0 ? (totalCorrect / totalDone) * 100 : -1;
                    if (accuracy !== -1) {
                        analysisList.push({ name: th.name, parentName: d.name, accuracy, totalDone });
                    }
                });
            });
        } else if (level === 'topic') {
            disciplines.forEach(d => {
                (d.themes || []).forEach(th => {
                    (th.topics || []).forEach(t => {
                        const totalDone = t.progress?.done || 0;
                        const totalCorrect = t.progress?.correct || 0;
                        const accuracy = totalDone > 0 ? (totalCorrect / totalDone) * 100 : -1;
                        if (accuracy !== -1) {
                            analysisList.push({ 
                                name: t.name, 
                                parentName: `${th.name} / ${d.name}`, 
                                accuracy, 
                                totalDone, 
                                hasNotes: t.notes && t.notes.trim() !== '', 
                                ids: { dId: d.id, thId: th.id, tId: t.id } 
                            });
                        }
                    });
                });
            });
        }

        analysisList = analysisList.filter(item => item.accuracy !== -1).sort((a, b) => a.accuracy - b.accuracy);
        
        DOM.criticalSubjectsList.innerHTML = '';
        if (analysisList.length > 0) {
            analysisList.forEach(item => {
                const colorClass = item.accuracy < 50 ? 'text-red-500' : item.accuracy < 75 ? 'text-amber-500' : 'text-green-500';
                
                let actionButtons = '';
                
                if (level === 'topic' && item.totalDone > 0) {
                    actionButtons += `
                        <button class="action-btn-review ml-2 p-1 bg-indigo-200 rounded-full hover:bg-indigo-300 dark:bg-indigo-800/50 dark:hover:bg-indigo-700" title="Agendar Revis√£o" data-d-id="${item.ids.dId}" data-th-id="${item.ids.thId}" data-t-id="${item.ids.tId}">
                            <svg class="w-4 h-4 text-indigo-700 dark:text-indigo-300" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/></svg>
                        </button>
                    `;
                }
                
                if (level === 'topic' && item.hasNotes) {
                    actionButtons += `
                        <button class="action-btn-notes ml-2 p-1 bg-amber-200 rounded-full hover:bg-amber-300 dark:bg-amber-800/50 dark:hover:bg-amber-700" title="Ver Anota√ß√µes" data-d-id="${item.ids.dId}" data-th-id="${item.ids.thId}" data-t-id="${item.ids.tId}">
                            <svg class="w-4 h-4 text-amber-700 dark:text-amber-300" fill="currentColor" viewBox="0 0 20 20"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828zM5 12V7a1 1 0 011-1h2.172a2 2 0 001.414-.586l1-1a2 2 0 012.828 0l1 1a2 2 0 001.414.586H17a1 1 0 011 1v5a1 1 0 01-1 1H6a1 1 0 01-1-1z"/></svg>
                        </button>
                    `;
                }

                DOM.criticalSubjectsList.innerHTML += `
                    <div class="flex justify-between items-center p-3 bg-slate-100 dark:bg-slate-700 rounded-lg">
                        <div>
                            <span class="font-semibold">${item.name}</span>
                            ${item.parentName ? `<p class="text-xs text-slate-500 dark:text-slate-400">${item.parentName}</p>` : ''}
                        </div>
                        <div class="flex items-center">
                            <span class="font-bold ${colorClass}">${item.accuracy.toFixed(1)}% de acerto</span>
                            ${actionButtons}
                        </div>
                    </div>
                `;
            });
        } else {
            DOM.criticalSubjectsList.innerHTML = '<p class="text-slate-500 dark:text-slate-400">Nenhum hist√≥rico de quest√µes para analisar neste n√≠vel.</p>';
        }
    }

    DOM.criticalSubjectsList.addEventListener('click', e => {
        const notesBtn = e.target.closest('.action-btn-notes');
        const reviewBtn = e.target.closest('.action-btn-review');
        
        if (notesBtn) {
            const { dId, thId, tId } = notesBtn.dataset;
            const topic = getTopic(dId, thId, tId);
            if (topic) {
                activeTopicIds = { disciplineId: dId, themeId: thId, topicId: tId };
                DOM.notesModal.title.querySelector('h2').textContent = `Anota√ß√µes - ${topic.name}`;
                DOM.notesModal.editor.innerHTML = topic.notes || ""; 
                // Garante que n√£o esteja maximizado ao abrir
                DOM.notesModal.modal.classList.remove('maximized');
                DOM.notesModal.modal.querySelector('.maximize-icon').classList.remove('hidden');
                DOM.notesModal.modal.querySelector('.restore-icon').classList.add('hidden');
                openModal(DOM.notesModal.modal);
            }
        } else if (reviewBtn) {
             const { dId, thId, tId } = reviewBtn.dataset;
             const topic = getTopic(dId, thId, tId);
             if (topic) {
                 activeTopicIds = { disciplineId: dId, themeId: thId, topicId: tId };
                 DOM.reviewModal.customDate.value = '';
                 openModal(DOM.reviewModal.modal);
             }
        }
    });

    DOM.startReviewSessionBtn.addEventListener('click', () => {
        const today = getToday();
        const allTopics = disciplines.flatMap(d => (d.themes || []).flatMap(th => (th.topics || []).map(t => ({...t, disciplineId: d.id, themeId: th.id, disciplineName: d.name}))));
        const reviews = allTopics.filter(t => t.nextReviewDate && getLocalDateObject(t.nextReviewDate) <= getLocalDateObject(today));
        
        if (reviews.length > 0) {
            reviewSessionState = { active: true, reviews: [...reviews], currentIndex: 0 };
            openModal(DOM.reviewSessionModal);
            showNextReviewInSession();
        }
    });

    function showNextReviewInSession() {
        // Se a sess√£o n√£o estiver ativa (ex: fechou o modal de conclus√£o), ou se n√£o houver mais revis√µes
        if (!reviewSessionState.active || reviewSessionState.currentIndex >= reviewSessionState.reviews.length || reviewSessionState.reviews.length === 0) {
            DOM.reviewSessionContent.innerHTML = `
                <h2 class="text-2xl font-bold mb-4 text-green-500 dark:text-green-400">Parab√©ns!</h2>
                <p class="text-slate-600 dark:text-slate-400 mb-6">Voc√™ concluiu todas as revis√µes de hoje.</p>
                <button class="close-session-btn bg-indigo-600 text-white font-semibold py-2 px-6 rounded-lg">Fechar</button>
            `;
            reviewSessionState.active = false; // Garante que a sess√£o seja desativada ao concluir
            return;
        }

        const topic = reviewSessionState.reviews[reviewSessionState.currentIndex];
        const progress = reviewSessionState.currentIndex + 1;
        const total = reviewSessionState.reviews.length;
        
        DOM.reviewSessionContent.innerHTML = `
            <div class="flex justify-between items-center border-b pb-3 mb-4 dark:border-slate-700">
                <h2 class="text-2xl font-bold">Sess√£o de Revis√£o</h2>
                <span class="font-semibold text-slate-500 dark:text-slate-400">${progress} / ${total}</span>
            </div>
            <h3 class="text-xl font-semibold mb-2">${topic.name}</h3>
            <p class="text-sm text-slate-500 dark:text-slate-400 mb-6">${topic.disciplineName}</p>
            <div class="space-y-4 mb-8">
                <button class="session-action-btn w-full p-4 rounded-lg bg-slate-100 hover:bg-slate-200 dark:bg-slate-700 dark:hover:bg-slate-600" data-action="notes">Ver/Editar Anota√ß√µes</button>
                ${topic.materialLink ? `<a href="${topic.materialLink}" target="_blank" rel="noopener noreferrer" class="session-action-btn block text-center w-full p-4 rounded-lg bg-slate-100 hover:bg-slate-200 dark:bg-slate-700 dark:hover:bg-slate-600">Abrir Material de Apoio</a>` : ''}
            </div>
                <div class="flex justify-between items-center mt-6 pt-4 border-t dark:border-slate-700">
                   <button class="session-action-btn text-sm text-slate-500 hover:text-slate-800 dark:text-slate-400 dark:hover:text-slate-200" data-action="skip">Pular por agora</button>
                   <button class="session-action-btn bg-green-600 text-white font-semibold py-3 px-6 rounded-lg" data-action="complete">Concluir Revis√£o</button>
            </div>
        `;
    }

    DOM.reviewSessionContent.addEventListener('click', e => {
        // Usa `close-session-btn` para fechar definitivamente a sess√£o.
        const btn = e.target.closest('.session-action-btn, .close-session-btn, .close-modal-btn');
        if(!btn) return;
        
        if (btn.classList.contains('close-session-btn') || btn.classList.contains('close-modal-btn')) {
            reviewSessionState.active = false; // Garante que a sess√£o seja encerrada
            closeModal();
            return;
        }
        
        if (!reviewSessionState.active) return;


        const { action } = btn.dataset;
        const topic = reviewSessionState.reviews[reviewSessionState.currentIndex];
        // Define o activeTopicIds antes de abrir modais aninhados
        activeTopicIds = { disciplineId: topic.disciplineId, themeId: topic.themeId, topicId: topic.id };

        if (action === 'complete') {
            openModal(DOM.reviewModal.modal);
        } else if (action === 'skip') {
            handleNextReviewInSession(false);
        } else if (action === 'notes') {
            DOM.notesModal.title.querySelector('h2').textContent = `Anota√ß√µes - ${topic.name}`;
            DOM.notesModal.editor.innerHTML = topic.notes || "";
            // Garante que n√£o esteja maximizado ao abrir
            DOM.notesModal.modal.classList.remove('maximized');
            DOM.notesModal.modal.querySelector('.maximize-icon').classList.remove('hidden');
            DOM.notesModal.modal.querySelector('.restore-icon').classList.add('hidden');
            // Simplesmente abre o modal, o fluxo de fechamento retornar√° a este modal.
            openModal(DOM.notesModal.modal);
        }
    });

    function handleNextReviewInSession(wasCompleted = true) {
        if(wasCompleted){
            // Se conclu√≠do, remove o item da lista (e o √≠ndice atual n√£o precisa avan√ßar)
            reviewSessionState.reviews.splice(reviewSessionState.currentIndex, 1);
        } else {
            // Se pulado, avan√ßa para o pr√≥ximo item
            reviewSessionState.currentIndex++;
        }
        // Exibe o pr√≥ximo item (ou a tela de conclus√£o)
        showNextReviewInSession();
    }


    DOM.clearAllBtn.addEventListener('click', async () => {
        if (confirm('ATEN√á√ÉO! Isso ir√° apagar TODO o seu planejamento (mat√©rias, temas, assuntos e hist√≥rico). Deseja continuar?')) {
            try {
                await localforage.clear(); 
                localStorage.removeItem('studyDataV10'); 
            } catch (e) {
                console.error("Erro ao limpar armazenamento.", e);
            }
            
            disciplines = [];
            questionHistory = [];
            dailyQuestionsTotal = 0;
            openDisciplines = new Set();
            openThemes = new Set();
            for (const dId in timers) {
                stopTimerInterval(dId);
                timers[dId] = { time: 0, interval: null, isRunning: false };
            }
            await saveData(); 
            
            lastCycleResults = null;
            lastCycleSchedule = null;
            selectedDisciplineId = null;
            await renderAll();
            alert('Planejamento zerado com sucesso. Voc√™ est√° pronto para come√ßar do zero com um sistema robusto.');
        }
    });

    DOM.cycleCalculator.list.addEventListener('click', e => {
        const detailBtn = e.target.closest('.open-subject-questions-btn');
        if (detailBtn) {
            const row = detailBtn.closest('.grid');
            const disciplineName = row.querySelector('.cycle-discipline-name').value.trim();
            if (disciplineName) {
                openSubjectQuestionsModal(disciplineName);
            } else {
                alert('Por favor, primeiro digite o nome da mat√©ria.');
            }
            return;
        }
        
        const removeBtn = e.target.closest('.remove-cycle-discipline-btn');
        if(removeBtn) {
            removeBtn.closest('.grid').remove();
        }
    });

    DOM.editalPreviewContent.addEventListener('click', e => {
        const removeBtn = e.target.closest('.remove-preview-item');
        if (removeBtn) {
            const { materiaIndex, temaIndex, assuntoIndex } = removeBtn.dataset;
            
            if (tempEditalData[materiaIndex] && tempEditalData[materiaIndex].themes[temaIndex]) {
                tempEditalData[materiaIndex].themes[temaIndex].assuntos.splice(assuntoIndex, 1);
                
                if (tempEditalData[materiaIndex].themes[temaIndex].assuntos.length === 0) {
                    tempEditalData[materiaIndex].themes.splice(temaIndex, 1);
                }
                
                if (tempEditalData[materiaIndex].themes.length === 0) {
                    tempEditalData.splice(materiaIndex, 1);
                }
            }
            
            renderEditalPreview(tempEditalData);
        }
    });

    DOM.subjectQuestionsModal.saveBtn.addEventListener('click', async () => {
        const M = DOM.subjectQuestionsModal;
        const disciplineId = M.modal.dataset.disciplineId;
        const totalCalculated = parseInt(M.modal.dataset.totalCalculated, 10);
        if (!disciplineId) return;

        const inputs = M.content.querySelectorAll('input[type="number"]');
        let currentSum = 0;
        inputs.forEach(input => {
            currentSum += parseInt(input.value, 10) || 0;
        });

        if (lastCycleResults && currentSum > totalCalculated) {
            alert(`A soma das quest√µes dos assuntos (${currentSum}) n√£o pode exceder o total calculado para a mat√©ria (${totalCalculated}). Ajuste os valores.`);
            return;
        }

        let hasChanged = false;
        inputs.forEach(input => {
            const { dId, thId, tId } = input.dataset;
            const newTotalQuestions = parseInt(input.value, 10);
            const finalValue = isNaN(newTotalQuestions) || newTotalQuestions < 0 ? 0 : newTotalQuestions;
            
            const topic = getTopic(dId, thId, tId);
            if (topic && topic.cycle.totalQuestions !== finalValue) {
                topic.cycle.totalQuestions = finalValue;
                hasChanged = true;
            }
        });

        if (hasChanged) {
            await saveData();
            await renderAll();
        }
        
        closeModal();
    });

    const darkModeToggle = document.getElementById('dark-mode-toggle');
    const themeToggleDarkIcon = document.getElementById('theme-toggle-dark-icon');
    const themeToggleLightIcon = document.getElementById('theme-toggle-light-icon');

    const applyTheme = (theme) => {
        const isDarkMode = theme === 'dark';
        if (isDarkMode) {
            document.documentElement.classList.add('dark');
            themeToggleLightIcon.classList.remove('hidden');
            themeToggleDarkIcon.classList.add('hidden');
            localStorage.setItem('theme', 'dark');
        } else {
            document.documentElement.classList.remove('dark');
            themeToggleDarkIcon.classList.remove('hidden');
            themeToggleLightIcon.classList.add('hidden');
            localStorage.setItem('theme', 'light');
        }
    };

    const initialTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
    applyTheme(initialTheme);

    darkModeToggle.addEventListener('click', () => {
        const currentTheme = document.documentElement.classList.contains('dark') ? 'light' : 'dark';
        applyTheme(currentTheme);
        if (activeModal === DOM.stats.modal) {
            renderStatsCharts();
        }
    });

    DOM.planning.btn.addEventListener('click', () => {
        DOM.planning.weekSelector.value = currentPlanningWeek;
        DOM.planning.filterDiscipline.innerHTML = '<option value="">Todas as Mat√©rias</option>';
        disciplines.forEach(d => {
            DOM.planning.filterDiscipline.innerHTML += `<option value="${d.id}">${d.name}</option>`;
        });
        
        renderPlanning(currentPlanningWeek, DOM.planning.filterDiscipline.value);
        openModal(DOM.planning.modal);
    });

    DOM.planning.weekSelector.addEventListener('change', (e) => {
        currentPlanningWeek = e.target.value;
        renderPlanning(currentPlanningWeek, DOM.planning.filterDiscipline.value);
    });

    DOM.planning.filterDiscipline.addEventListener('change', (e) => {
        renderPlanning(currentPlanningWeek, e.target.value);
    });

    DOM.planning.prevWeekBtn.addEventListener('click', () => {
        const [year, weekStr] = currentPlanningWeek.split('-W');
        let week = parseInt(weekStr, 10);
        let currentYear = parseInt(year, 10);
        
        if (week > 1) {
            week--;
        } else {
            currentYear--;
            const lastWeekDate = new Date(currentYear, 11, 28);
            const d = new Date(Date.UTC(lastWeekDate.getFullYear(), lastWeekDate.getMonth(), lastWeekDate.getDate()));
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
            week = weekNo;
        }

        currentPlanningWeek = currentYear + '-W' + String(week).padStart(2, '0');
        DOM.planning.weekSelector.value = currentPlanningWeek;
        renderPlanning(currentPlanningWeek, DOM.planning.filterDiscipline.value);
    });

    DOM.planning.nextWeekBtn.addEventListener('click', () => {
        const [year, weekStr] = currentPlanningWeek.split('-W');
        let week = parseInt(weekStr, 10);
        let currentYear = parseInt(year, 10);

        const nextWeekDate = new Date(currentYear, 11, 28);
        const d = new Date(Date.UTC(nextWeekDate.getFullYear(), nextWeekDate.getMonth(), nextWeekDate.getDate()));
        const dayNum = d.getUTCDay() || 7;
        d.setUTCDate(d.getUTCDate() + 4 - dayNum);
        const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
        const maxWeekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);

        if (week < maxWeekNo) {
            week++;
        } else {
            currentYear++;
            week = 1;
        }

        currentPlanningWeek = currentYear + '-W' + String(week).padStart(2, '0');
        DOM.planning.weekSelector.value = currentPlanningWeek;
        renderPlanning(currentPlanningWeek, DOM.planning.filterDiscipline.value);
    });


    function renderPlanning(weekString, disciplineId = "") {
        const calendarContainer = DOM.planning.calendarContent;
        const summaryContainer = DOM.planning.summaryContent;

        const dateParts = weekString.split('-');
        if(dateParts.length < 2) return;
        
        const year = parseInt(dateParts[0]);
        const week = parseInt(dateParts[1].replace('W', ''));

        const date = new Date(year, 0, 4);
        date.setDate(date.getDate() + (week - 1) * 7);
        let startOfWeek = date;
        startOfWeek.setDate(date.getDate() - date.getDay());
        startOfWeek.setHours(0, 0, 0, 0);

        const daysInWeek = [];
        for (let i = 0; i < 7; i++) {
            const day = new Date(startOfWeek);
            day.setDate(startOfWeek.getDate() + i);
            daysInWeek.push(day);
        }
        
        const filteredDisciplines = disciplineId
            ? disciplines.filter(d => String(d.id) === String(disciplineId))
            : disciplines;
        
        if (filteredDisciplines.length === 0) {
            calendarContainer.innerHTML = '<p class="text-red-500 text-center">Nenhuma mat√©ria encontrada com este filtro.</p>';
            summaryContainer.innerHTML = '<p class="text-red-500 text-center">Nenhuma mat√©ria encontrada com este filtro.</p>';
            return;
        }

        const weeklyPlan = {};
        const weeklySummary = {};

        filteredDisciplines.forEach(d => {
            const sessionsPerDay = [0, 0, 0, 0, 0, 0, 0];
            let totalWeeklyQuestions = 0;
            
            d.studyDays.forEach(dayIndex => {
                const questions = d.dailyGoal || 0;
                sessionsPerDay[dayIndex] = questions;
                totalWeeklyQuestions += questions;
            });

            if (totalWeeklyQuestions > 0) {
                 weeklyPlan[d.name] = sessionsPerDay;
                 weeklySummary[d.name] = totalWeeklyQuestions;
            }
        });

        let calendarHtml = `<table class="min-w-full divide-y divide-slate-300 dark:divide-slate-700 text-xs">
            <thead>
                <tr class="bg-slate-100 dark:bg-slate-700/70">
                    <th class="p-2 text-left font-bold w-[100px] sticky left-0 bg-slate-100 dark:bg-slate-700/70">Mat√©ria</th>
                    ${daysInWeek.map((day, index) => `<th class="p-2 text-center font-bold min-w-[100px]">${weekDays[index]} <br> <span class="text-slate-500 dark:text-slate-400">${day.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' })}</span></th>`).join('')}
                    <th class="p-2 text-right font-bold w-[100px]">Total Semanal</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-slate-200 dark:divide-slate-700">`;

        const disciplineNames = Object.keys(weeklyPlan).sort();
        let totalQuestionsByDay = [0, 0, 0, 0, 0, 0, 0];

        disciplineNames.forEach(name => {
            const dailyQuestions = weeklyPlan[name];
            let rowTotal = 0;

            calendarHtml += `<tr>
                <td class="p-2 text-left font-medium sticky left-0 bg-white dark:bg-slate-800">${name}</td>
                ${dailyQuestions.map((q, index) => {
                    const cell = q > 0 ? `<div class="p-1 rounded-md ${q > 0 ? 'bg-indigo-100 dark:bg-indigo-900/50 text-indigo-800 dark:text-indigo-300 font-semibold' : ''}">${q} Q</div>` : '';
                    if (q > 0) {
                        totalQuestionsByDay[index] += q;
                        rowTotal += q;
                    }
                    return `<td class="p-2 text-center">${cell}</td>`;
                }).join('')}
                <td class="p-2 text-right font-bold bg-slate-50 dark:bg-slate-900/50">${rowTotal} Q</td>
            </tr>`;
        });

        const totalWeeklyPlan = totalQuestionsByDay.reduce((a,b) => a+b, 0);

        calendarHtml += `</tbody>
            <tfoot class="font-bold bg-slate-200 dark:bg-slate-700">
                <tr>
                    <td class="p-2 text-left sticky left-0 bg-slate-200 dark:bg-slate-700">TOTAL DO DIA</td>
                    ${totalQuestionsByDay.map(q => `<td class="p-2 text-center">${q} Q</td>`).join('')}
                    <td class="p-2 text-right">${totalWeeklyPlan} Q</td>
                </tr>
            </tfoot>
        </table>`;

        calendarContainer.innerHTML = calendarHtml;

        let summaryHtml = `<table class="min-w-full divide-y divide-slate-300 dark:divide-slate-700 text-sm">
            <thead>
                <tr class="bg-slate-100 dark:bg-slate-700/70">
                    <th class="p-2 text-left font-bold">Mat√©ria</th>
                    <th class="p-2 text-right font-bold">Meta Semanal (Q)</th>
                    <th class="p-2 text-right font-bold">Meta Di√°ria (Q)</th>
                    <th class="p-2 text-right font-bold">Dias de Estudo</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-slate-200 dark:divide-slate-700">`;

        disciplineNames.forEach(name => {
            const discipline = filteredDisciplines.find(d => d.name === name);
            if (!discipline) return;
            
            const totalWeekly = weeklySummary[name];
            const dailyGoal = discipline.dailyGoal || 0;
            const studyDaysCount = discipline.studyDays.length;

            summaryHtml += `<tr>
                <td class="p-2 text-left font-medium">${name}</td>
                <td class="p-2 text-right">${totalWeekly}</td>
                <td class="p-2 text-right">${dailyGoal}</td>
                <td class="p-2 text-right">${studyDaysCount}</td>
            </tr>`;
        });

        summaryHtml += `</tbody></table>`;
        summaryContainer.innerHTML = summaryHtml;
    }

    function resumeRunningTimers() {
        for (const dId in timers) {
            if (timers[dId].isRunning) {
                startTimerInterval(dId);
            }
        }
    }

    // =========================================================================
    // FUN√á√ÉO DE INICIALIZA√á√ÉO AS√çNCRONA E PONTO DE ENTRADA
    // =========================================================================
    const init = async () => {
        await loadData();
        resumeRunningTimers();
        await renderAll();
        renderCycleStudyDaysCheckboxes();
        showInitialReviews();
        initStatsModal();
    };

    init();

    window.addEventListener('beforeunload', saveData);
});
// =========================================================================
// FIM DO SCRIPT JAVASCRIPT COMPLETO E CORRIGIDO (V11)
// =========================================================================
    </script>
</body>
</html>